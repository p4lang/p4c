<!-- HTML header for doxygen 1.11.0-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.11.0"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>P4C: P4Testgen</title>
<link rel="icon" href="p4-fav.svg" type="image/svg+xml"  />
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<!--  Add link to paragraphs   -->
<script type="text/javascript" src="doxygen-awesome-paragraph-link.js"></script>
<script type="text/javascript">
  DoxygenAwesomeParagraphLink.init()
</script>
<!-- Add copy button to code fragments  -->
<script type="text/javascript" src="doxygen-awesome-fragment-copy-button.js"></script>
<script type="text/javascript">
  DoxygenAwesomeFragmentCopyButton.init()
</script>
<!-- Add dark mode toggle -->
<script type="text/javascript" src="doxygen-awesome-darkmode-toggle.js"></script>
<script type="text/javascript">
  DoxygenAwesomeDarkModeToggle.init()
</script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="cookie.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="doxygen-awesome.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectlogo"><img alt="Logo" src="p4-logo.png"/></td>
  <td id="projectalign">
   <div id="projectname">P4C
   </div>
   <div id="projectbrief">The P4 Compiler</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.11.0 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() { codefold.init(0); });
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search',true);
  $(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function(){initNavTree('md__2home_2runner_2work_2p4c_2p4c_2backends_2p4tools_2modules_2testgen_2_r_e_a_d_m_e.html',''); initResizable(true); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">P4Testgen</div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a class="anchor" id="autotoc_md135"></a> <a href="https://github.com/p4lang/p4c/actions/workflows/ci-p4tools.yml"><img src="https://github.com/p4lang/p4c/actions/workflows/ci-p4tools.yml/badge.svg" alt="Status" style="pointer-events: none;" class="inline"/></a></p>
<h1><a class="anchor" id="autotoc_md136"></a>
Table of Contents</h1>
<ul>
<li>Installation</li>
<li>Extensions</li>
<li>Usage<ul>
<li>Coverage</li>
<li>Generating Specific Tests</li>
<li>Interacting with Test Frameworks</li>
<li>Detecting P4 Program Flaws</li>
</ul>
</li>
<li>Limitations</li>
<li>Further Reading</li>
<li>Contributing</li>
<li>License</li>
</ul>
<p>P4Testgen is an extensible <a href="https://en.wikipedia.org/wiki/Test_oracle">test oracle</a> that uses symbolic execution to automatically generate input-output tests for <a class="el" href="namespace_p4.html">P4</a> programs. P4Testgen is part of the <a class="el" href="namespace_p4_tools.html">P4Tools</a> and P4C ecosystem.</p>
<h1><a class="anchor" id="autotoc_md137"></a>
Features</h1>
<ul>
<li><b>Exhaustive, automatic input-output test generation</b>: Given a <a class="el" href="namespace_p4.html">P4</a> program and sufficient time, P4Testgen generates tests that cover every reachable statement in the program. Each test consists of an input packet, control-plane configuration, and the expected output packet. Test case generation is configurable using command-line flags and assertions within the <a class="el" href="namespace_p4.html">P4</a> code. For example, it is possible to generate tests that use only TCP-IP packets as input.</li>
<li><b>Support for multiple <a class="el" href="namespace_p4.html">P4</a> targets</b>: P4Testgen is designed to be extensible for many <a class="el" href="namespace_p4.html">P4</a> targets. It models the complete semantics of the target's packet-processing pipeline, including the <a class="el" href="namespace_p4.html">P4</a> language, architectures, externs, and target-specific behaviors. Support for a <a class="el" href="namespace_p4.html">P4</a> target is implemented in the form of an extension. The open-source version of P4Testgen supports generating tests for the <a href="https://github.com/p4lang/behavioral-model/blob/main/docs/simple_switch.md">v1model.p4</a> architecture on <a href="https://github.com/p4lang/behavioral-model">BMv2</a>, the <a href="https://p4.org/p4-spec/docs/pna-working-draft-html-version.html">pna.p4</a> architecture on <a href="https://github.com/p4lang/p4-dpdk-target">DPDK-SoftNIC</a>, and the <a href="https://github.com/p4lang/p4c/tree/main/backends/ebpf">ebpf_model.p4</a> architecture on <a href="http://vger.kernel.org/lpc_net2018_talks/p4c-xdp-lpc18-paper.pdf">the Linux kernel</a>.</li>
<li><b>Support for multiple test frameworks</b>: P4Testgen generates abstract tests that can be serialized into formats suitable for any test framework. P4Testgen extensions can generate tests for STF, PTF, and P4Runtime Protobuf messages.</li>
<li><b>Coverage heuristics</b>: To limit the number of generated tests, P4Testgen uses coverage heuristics. It employs coverage-guided search to generate tests that cover new nodes in the <a class="el" href="namespace_p4.html">P4</a> program, such as statements or tables. P4Testgen also supports custom stop metrics to ensure that test case generation stops when a user-defined goal has been reached.</li>
</ul>
<h1><a class="anchor" id="autotoc_md138"></a>
Installation</h1>
<p>P4Testgen depends on the <a class="el" href="namespace_p4_tools.html">P4Tools</a> framework and is automatically installed with <a class="el" href="namespace_p4_tools.html">P4Tools</a>. Please follow the instructions listed <a href="https://github.com/p4lang/p4c/tree/main/backends/p4tools#building">here</a> to install P4Testgen. The main binary <code>p4testgen</code> can be found in the <code>build</code> folder after a successful installation.</p>
<p>P4Testgen is available as part of the <a href="https://hub.docker.com/r/p4lang/p4c/">official P4C docker image</a>. On Debian-based systems, it is also possible to install a P4Testgen binary by following <a href="https://github.com/p4lang/p4c#installing-packaged-versions-of-p4c">these</a> instructions.</p>
<h2><a class="anchor" id="autotoc_md139"></a>
Dependencies</h2>
<p>In addition to <a href="../README.md#dependencies">P4Tools'</a> own dependencies P4Testgen depends on the following external software:</p><ul>
<li><a href="https://github.com/pantor/inja">inja</a> template engine for testcase generation.</li>
</ul>
<p>These dependencies are automatically installed via CMakelist's <a href="https://cmake.org/cmake/help/latest/module/FetchContent.html">FetchContent</a> module.</p>
<h1><a class="anchor" id="autotoc_md140"></a>
Extensions</h1>
<p>P4Testgen extensions are instantiations of a particular combination of <a class="el" href="namespace_p4.html">P4</a> architecture and the target that executes the <a class="el" href="namespace_p4.html">P4</a> code. For example, the <code>v1model.p4</code> architecture can be executed on the behavioral model. P4Testgen extension make use of the core P4Testgen framework to generate tests. Several open-source extensions are available.</p>
<h2><a class="anchor" id="autotoc_md141"></a>
v1model.p4 on BMv2</h2>
<p><a href="targets/bmv2">targets/bmv2</a></p>
<p>P4Testgen supports generating <a href="https://github.com/p4lang/p4c/tree/main/tools/stf">STF</a>, <a href="https://github.com/p4lang/ptf">PTF</a>, <a href="https://protobuf.dev/overview/">Protobuf</a> messages, and Metadata templates for the <code>v1model</code> architecture on <a href="https://github.com/p4lang/behavioral-model">BMv2</a>. Almost all externs, including checksums, cloning, recirculation are supported. P4Testgen also supports <a href="https://github.com/p4lang/p4-constraints">P4Constraints</a> parsing.</p>
<h2><a class="anchor" id="autotoc_md142"></a>
pna.p4 on the DPDK SoftNIC</h2>
<p><a href="targets/pna">targets/pna</a></p>
<p>The <a href="https://github.com/p4lang/p4-dpdk-target">DPDK-SoftNIC</a> is a new target implemented using the <a href="https://www.dpdk.org/">Data Plane Development Kit (DPDK)</a>. The SoftNIC can be programmed using the <a class="el" href="namespace_p4.html">P4</a> <code>pna.p4</code> architecture.</p>
<h2><a class="anchor" id="autotoc_md143"></a>
ebpf_model.p4 on the eBPF kernel target</h2>
<p><a href="targets/ebpf">targets/ebpf</a></p>
<p>The P4Testgen eBPF extension is a proof-of-concept implementation. It supports generating tests for <a class="el" href="namespace_p4.html">P4</a> eBPF programs but, as the test framework and extern support is limited, so is the P4Testgen extension.</p>
<h1><a class="anchor" id="autotoc_md144"></a>
Definitions</h1>
<p>Useful definitions to keep in mind when using P4Testgen.</p>
<h3><a class="anchor" id="autotoc_md145"></a>
Paths and Path Constraints</h3>
<p>P4Testgen defines a path as a collection of path constraints. A path constraint is a boolean expression composed of constants and symbolic variables at a particular program point. For example, in the common case an if statement will branch into a <code>true</code> and a <code>false</code> branch. This will produce two new unique paths. P4Testgen only traverses a path if its constraints are feasible. A path constraint is feasible if an SMT solver is able to find a solution for the constraints. A path constraint such as <code>hdr.eth.eth_type == 0x800 &amp;&amp; hdr.eth.eth_type != 0x800</code> is never feasible.</p>
<h3><a class="anchor" id="autotoc_md146"></a>
Symbolic Variables</h3>
<p>A symbolic variable is a placeholder variable which is frequently part of path constraints. SMT solvers assign values to symbolic variables to satisfy a particular set of path constraints. In P4Testgen, symbolic variables typically correspond to test inputs. For example, the input packet and port are symbolic variables.</p>
<h3><a class="anchor" id="autotoc_md147"></a>
Taint</h3>
<p>P4Testgen uses bit-level taint tracking to keep track of nondeterminism in the <a class="el" href="namespace_p4.html">P4</a> program. An expression is considered tainted if the value of its bits (or simply just a sub-expression) is unpredictable. This could happen because of reads from an uninitialized variable, unimplemented checksums, or simply because of random generators. P4Testgen's core framework marks some constructs tainted, for example uninitialized variables, but otherwise leaves it up to the P4Testgen extension whether to mark a particular expression or method call tainted. Similiarly, it is up to the extension how tainted values are resolved. An extension can either ignore them or throw an error.</p>
<h1><a class="anchor" id="autotoc_md148"></a>
Usage</h1>
<p>To access the possible options for <code>p4testgen</code> use <code>p4testgen --help</code>. To generate a test for a particular target and <a class="el" href="namespace_p4.html">P4</a> architecture, run the following command:</p>
<div class="fragment"><div class="line">./p4testgen --target [TARGET] --arch [ARCH] --max-tests 10 --out-dir [OUT] prog.p4</div>
</div><!-- fragment --><p> Where <code>ARCH</code> specifies the <a class="el" href="namespace_p4.html">P4</a> architecture (e.g., v1model.p4) and <code>TARGET</code> represents the targeted network device (e.g., BMv2). Choosing <code>0</code> as the option for max-tests will cause P4Testgen to generate tests until it has exhausted all possible paths.</p>
<h2><a class="anchor" id="autotoc_md149"></a>
Coverage</h2>
<p>P4Testgen is able to track the (source code) coverage of the program it is generating tests for. With each test, P4Testgen can emit the cumulative program coverage it has achieved so far. Test 1 may have covered 2 out 10 <a class="el" href="namespace_p4.html">P4</a> nodes, test 2 5 out of 10 <a class="el" href="namespace_p4.html">P4</a> nodes, and so on. To enable program coverage, P4Testgen provides the <code>--track-coverage [NODE_TYPE]</code> option where <code>NODE_TYPE</code> refers to a particular <a class="el" href="namespace_p4.html">P4</a> source node. Currently, <code>STATEMENTS</code> for <a class="el" href="namespace_p4.html">P4</a> program statements and <code>TABLE_ENTRIES</code> for constant <a class="el" href="namespace_p4.html">P4</a> table entries are supported. Multiple uses of <code>--track-coverage</code> are possible.</p>
<p>The option <code>--stop-metric MAX_NODE_COVERAGE</code> makes P4Testgen stop once it has hit 100% coverage as determined by <code>--track-coverage</code>.</p>
<h2><a class="anchor" id="autotoc_md150"></a>
Generating Specific Tests</h2>
<p>P4Testgen supports the use of custom externs to restrict the breadth of possible input-output tests. These externs are <code>testgen_assume</code> and <code>testgen_assert</code>, which serve two different use cases: Generating restricted tests and finding assertion violations.</p>
<h3><a class="anchor" id="autotoc_md151"></a>
Restricted Tests</h3>
<p><code>testgen_assume(expr)</code> will add <code>expr</code> as a necessary path constraints to all subsequent execution. For example, for the following snippet </p><div class="fragment"><div class="line"> 4</div>
<div class="line">state parse_ethernet {</div>
<div class="line">    packet.extract(headers.ethernet);</div>
<div class="line">    testgen_assume(headers.ethernet.ether_type == 0x800);</div>
<div class="line">    transition select(headers.ethernet.ether_type) {</div>
<div class="line">        0x800: parse_ipv4;</div>
<div class="line">        0x86dd: parse_ipv6;</div>
<div class="line">        default: accept;</div>
<div class="line">    }</div>
<div class="line">}</div>
</div><!-- fragment --><p> only inputs which have <code>0x800</code> as Ethertype will be generated. This mode is enable by default and can be disabled with the flag <code>--disable-assumption-mode</code>.</p>
<h3><a class="anchor" id="autotoc_md152"></a>
Finding Assertion Violations</h3>
<p>Conversely, <code>testgen_assert(expr)</code> can be used to find violations in a particular <a class="el" href="namespace_p4.html">P4</a> program. By default, <code>testgen_assert</code> behaves like <code>testgen_assume</code>. If the flag <code>--assertion-mode</code> is enabled, P4Testgen will only generate tests that will cause <code>expr</code> to be false and, hence, violate the assertion. For example, for </p><div class="fragment"><div class="line"> 4</div>
<div class="line">state parse_ethernet {</div>
<div class="line">    packet.extract(headers.ethernet);</div>
<div class="line">    transition select(headers.ethernet.ether_type) {</div>
<div class="line">        0x800: parse_ipv4;</div>
<div class="line">        0x86dd: parse_ipv6;</div>
<div class="line">        default: accept;</div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="line">state parse_ipv4 {</div>
<div class="line">    packet.extract(headers.ipv4);</div>
<div class="line">    testgen_assert(!headers.ipv6.isValid());</div>
<div class="line">    transition select(headers.ethernet.ether_type) {</div>
<div class="line">        0x800: parse_ipv4;</div>
<div class="line">        0x86dd: parse_ipv6;</div>
<div class="line">        default: accept;</div>
<div class="line">    }</div>
<div class="line">}</div>
</div><!-- fragment --><p> with <code>--assertion-mode</code> enabled, P4Testgen will try to generate tests that violated the condition <code>testgen_assert(!headers.ipv6.isValid());</code>.</p>
<h2><a class="anchor" id="autotoc_md153"></a>
Interacting with Test Frameworks</h2>
<p>Generally, P4Testgen <b>only</b> generates tests. It does not invoke test frameworks or run end-to-end tests. However, many of the extensions supply tests that do so. Each extension has their own scripts and CMake implementation for these test scripts. These can be run with <code>ctest -R testgen-p4c-[extension]</code>. Concretely, <code>ctest -V -R testgen-p4c-bmv2/</code> will run the v1model BMv2 STF tests.</p>
<h2><a class="anchor" id="autotoc_md154"></a>
Detecting P4 Program Flaws</h2>
<p>P4Testgen can also be used to detect flaws in <a class="el" href="namespace_p4.html">P4</a> program. P4Testgen supplies a strict mode (enabled with the flag <code>--strict</code>), which fails when the interpreter encounters unrecoverable tainted behavior in the program.</p>
<p>Coverage tracking can also be used to identify dead code in the program. If P4Testgen does not achieve 100% coverage within a reasonable amount of time (say 10k tests or an hour of test generation) one can use the <code>--print-coverage</code> to emit the nodes which can not be covered. Often, P4Testgen simply does have control-plane support for the node, but in many cases the code may simply not executable.</p>
<h1><a class="anchor" id="autotoc_md155"></a>
Limitations</h1>
<p>P4Testgen only performs functional validation for single inputs. It does not support tests which involve multiple packets as input. It also does not support generating any performance or resource usage tests. Target-specific limitations are documented in the corresponding relevant target-folder or Github issue.</p>
<h1><a class="anchor" id="autotoc_md156"></a>
Further Reading</h1>
<p>P4Testgen has been published at SIGCOMM 2023. The paper describing the tool is available <a href="https://arxiv.org/abs/2211.15300">here</a>.</p>
<p>A talk is also available on Youtube: <a href="https://www.youtube.com/watch?v=yucl3azbh8Q">p4testgen: Automated Test Generation for Real-World P4 Data Planes</a></p>
<p>If you would like to cite this work please use this citation format: </p><div class="fragment"><div class="line">@inproceedings{ruffy-sigcom2023,</div>
<div class="line">    author = {Ruffy, Fabian and Liu, Jed and Kotikalapudi, Prathima and Havel, VojtÄ›ch and Tavante, Hanneli and Sherwood, Rob and Dubina, Vladislav and Peschanenko, Volodymyr and Sivaraman, Anirudh and Foster, Nate},</div>
<div class="line">    title = {{P4Testgen}: An Extensible Test Oracle For {P4}},</div>
<div class="line">    booktitle={Proceedings of the ACM SIGCOMM 2023 Conference. 2023},</div>
<div class="line">    year = {2023},</div>
<div class="line">    month = sep,</div>
<div class="line">    publisher = {Association for Computing Machinery},</div>
<div class="line">    abstract = {We present P4Testgen, a test oracle for the P4-16. P4Testgen supports automatic test generation for any P4 target and is designed to be extensible to many P4 targets. It models the complete semantics of the target&#39;s packet-processing pipeline including the P4 language, architectures and externs, and target-specific extensions. To handle non-deterministic behaviors and complex externs (e.g., checksums and hash functions), P4Testgen uses taint tracking and concolic execution. It also provides path selection strategies that reduce the number of tests required to achieve full coverage. We have instantiated P4Testgen for the V1model, eBPF, PNA, and Tofino P4 architectures. Each extension required effort commensurate with the complexity of the target. We validated the tests generated by P4Testgen by running them across the entire P4C test suite as well as the programs supplied with the Tofino P4 Studio. Using the tool, we have also confirmed 25 bugs in mature, production toolchains for BMv2 and Tofino.}</div>
<div class="line">}</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md157"></a>
Contributing</h1>
<p>Contributions to P4Testgen in any form are welcome! Please follow the guidelines listed <a href="https://github.com/p4lang/p4c/blob/main/CONTRIBUTING.md">here</a> to contribute.</p>
<h1><a class="anchor" id="autotoc_md158"></a>
License</h1>
<p>This project is licensed under the Apache License 2.0. See the <a href="https://github.com/p4lang/p4c/blob/main/backends/p4tools/LICENSE">LICENSE</a> file for details. </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- HTML footer for doxygen 1.11.0-->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.11.0 </li>
  </ul>
</div>
</body>
</html>
