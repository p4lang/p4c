<!-- HTML header for doxygen 1.12.0-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.12.0"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>P4 Compiler Documentation (P4C): FindPayloadCandidates Class Reference</title>
<link rel="icon" href="p4-fav.svg" type="image/x-icon" />
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<!--  Add link to paragraphs   -->
<script type="text/javascript" src="doxygen-awesome-paragraph-link.js"></script>
<script type="text/javascript">
  DoxygenAwesomeParagraphLink.init()
</script>
<!-- Add copy button to code fragments  -->
<script type="text/javascript" src="doxygen-awesome-fragment-copy-button.js"></script>
<script type="text/javascript">
  DoxygenAwesomeFragmentCopyButton.init()
</script>
<!-- Add dark mode toggle -->
<script type="text/javascript" src="doxygen-awesome-darkmode-toggle.js"></script>
<script type="text/javascript">
  DoxygenAwesomeDarkModeToggle.init()
</script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="cookie.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="doxygen-awesome.css" rel="stylesheet" type="text/css"/>
<link href="doxygen-awesome-sidebar-only.css" rel="stylesheet" type="text/css"/>
<link href="doxygen-awesome-sidebar-only-darkmode-toggle.css" rel="stylesheet" type="text/css"/>
<link href="cards.css" rel="stylesheet" type="text/css"/>
<link href="flow.css" rel="stylesheet" type="text/css"/>
<link href="p4c_custom.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectlogo"><img alt="Logo" src="p4-logo.png"/></td>
  <td id="projectalign">
   <div id="projectname">P4C
   </div>
   <div id="projectbrief">The P4 Compiler</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.12.0 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() { codefold.init(0); });
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search',true);
  $(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function(){initNavTree('class_find_payload_candidates.html',''); initResizable(true); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div class="header">
  <div class="summary">
<a href="#pub-types">Public Types</a> &#124;
<a href="#pub-methods">Public Member Functions</a> &#124;
<a href="#pub-static-methods">Static Public Member Functions</a> &#124;
<a href="#pub-static-attribs">Static Public Attributes</a> &#124;
<a href="class_find_payload_candidates-members.html">List of all members</a>  </div>
  <div class="headertitle"><div class="title">FindPayloadCandidates Class Reference</div></div>
</div><!--header-->
<div class="contents">
<table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a id="pub-types" name="pub-types"></a>
Public Types</h2></td></tr>
<tr class="memitem:a0f8f18d5744f035ff2d4539d6a854223" id="r_a0f8f18d5744f035ff2d4539d6a854223"><td class="memItemLeft" align="right" valign="top"><a id="a0f8f18d5744f035ff2d4539d6a854223" name="a0f8f18d5744f035ff2d4539d6a854223"></a>
using&#160;</td><td class="memItemRight" valign="bottom"><b>PayloadArguments</b> = std::vector&lt;const IR::Constant *&gt;</td></tr>
<tr class="separator:a0f8f18d5744f035ff2d4539d6a854223"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a id="pub-methods" name="pub-methods"></a>
Public Member Functions</h2></td></tr>
<tr class="memitem:a2828efa3466ef79633f08a5cdebd26c4" id="r_a2828efa3466ef79633f08a5cdebd26c4"><td class="memItemLeft" align="right" valign="top"><a id="a2828efa3466ef79633f08a5cdebd26c4" name="a2828efa3466ef79633f08a5cdebd26c4"></a>
&#160;</td><td class="memItemRight" valign="bottom"><b>FindPayloadCandidates</b> (const <a class="el" href="class_phv_info.html">PhvInfo</a> &amp;p)</td></tr>
<tr class="separator:a2828efa3466ef79633f08a5cdebd26c4"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a33b30a26b0df7f23adcbfe16e988fcff" id="r_a33b30a26b0df7f23adcbfe16e988fcff"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="#a33b30a26b0df7f23adcbfe16e988fcff">add_option</a> (const IR::MAU::Table *, <a class="el" href="class_layout_choices.html">LayoutChoices</a> &amp;lc)</td></tr>
<tr class="separator:a33b30a26b0df7f23adcbfe16e988fcff"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a033506ed9e5ce1b85adee8315b56b1d8" id="r_a033506ed9e5ce1b85adee8315b56b1d8"><td class="memItemLeft" align="right" valign="top"><a id="a033506ed9e5ce1b85adee8315b56b1d8" name="a033506ed9e5ce1b85adee8315b56b1d8"></a>
void&#160;</td><td class="memItemRight" valign="bottom"><b>clear</b> ()</td></tr>
<tr class="separator:a033506ed9e5ce1b85adee8315b56b1d8"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a99681f18bb90021f79a05f52b1827647" id="r_a99681f18bb90021f79a05f52b1827647"><td class="memItemLeft" align="right" valign="top">IR::MAU::Table *&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="#a99681f18bb90021f79a05f52b1827647">convert_to_gateway</a> (const IR::MAU::Table *)</td></tr>
<tr class="separator:a99681f18bb90021f79a05f52b1827647"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a id="pub-static-methods" name="pub-static-methods"></a>
Static Public Member Functions</h2></td></tr>
<tr class="memitem:a2ae340a7b20b6d4e5e0e1c56cf5b721c" id="r_a2ae340a7b20b6d4e5e0e1c56cf5b721c"><td class="memItemLeft" align="right" valign="top">static <a class="el" href="class_p4_1_1bitvec.html">bitvec</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="#a2ae340a7b20b6d4e5e0e1c56cf5b721c">determine_payload</a> (const IR::MAU::Table *tbl, const <a class="el" href="struct_table_resource_alloc.html">TableResourceAlloc</a> *alloc, const IR::MAU::Table::Layout *layout)</td></tr>
<tr class="separator:a2ae340a7b20b6d4e5e0e1c56cf5b721c"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a id="pub-static-attribs" name="pub-static-attribs"></a>
Static Public Attributes</h2></td></tr>
<tr class="memitem:aa0bd2ba71637f8201e7de802ee089171" id="r_aa0bd2ba71637f8201e7de802ee089171"><td class="memItemLeft" align="right" valign="top"><a id="aa0bd2ba71637f8201e7de802ee089171" name="aa0bd2ba71637f8201e7de802ee089171"></a>
static constexpr int&#160;</td><td class="memItemRight" valign="bottom"><b>GATEWAY_ROWS_FOR_ENTRIES</b> = 4</td></tr>
<tr class="separator:aa0bd2ba71637f8201e7de802ee089171"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table>
<h2 class="groupheader">Member Function Documentation</h2>
<a id="a33b30a26b0df7f23adcbfe16e988fcff" name="a33b30a26b0df7f23adcbfe16e988fcff"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a33b30a26b0df7f23adcbfe16e988fcff">&#9670;&#160;</a></span>add_option()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void FindPayloadCandidates::add_option </td>
          <td>(</td>
          <td class="paramtype">const IR::MAU::Table *</td>          <td class="paramname"><span class="paramname"><em>tbl</em></span>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="class_layout_choices.html">LayoutChoices</a> &amp;</td>          <td class="paramname"><span class="paramname"><em>lc</em></span>&#160;)</td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Copyright (C) 2024 Intel Corporation</p>
<p>Licensed under the Apache License, Version 2.0 (the "License"); you may not use this file except in compliance with the License. You may obtain a copy of the License at</p>
<p><a href="http://www.apache.org/licenses/LICENSE-2.0">http://www.apache.org/licenses/LICENSE-2.0</a></p>
<p>Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on an "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the specific language governing permissions and limitations under the License.</p>
<p>SPDX-License-Identifier: Apache-2.0 A gateway in Tofino2 and future generations can be used to implement a small match table. For some context, a gateway is a 5 entry TCAM that has been used to implement conditionals. Examine the following example:</p>
<p>if (condition) { x.apply(); } else { y.apply(); } z.apply();</p>
<p>The gateway as a logical table can set the next table based on the evaluation of the condition. The gateway rows can be thought of as:</p>
<p>____match____|__next_table__ condition | x miss | y</p>
<p>A gateway can be linked with a match table as a single logical table. The gateway will verify its condition, and if the condition is false, can override the match table. This process is known as inhibiting. When the gateway inhibits, the next table comes from the gateway. If the gateway does not inhibit, the next table comes from the match table. Let's say, for example, that table x and the condition were merged into a single logical table. The gateway rows can be thought of as:</p>
<p>____match____|__inhibit__|__next_table__ condition | false | N/A (comes from x's execution, in this case z) miss | true | y</p>
<p>Now, what actually happens on an inhibit. In match central, there are two pathways for table execution, a hit pathway and a miss pathway. When the gateway inhibits, the gateway will automatically force the logical table to enter the hit pathway (even if the underlying match_table missed). The 83 bit result bus, the input to the hit pathway, is overwritten by the gateway with a 83 bit value. This value is called the payload.</p>
<p>For the standard example, the gateway payload is an all 0 value. Match central is then programmed to interpret the all 0 payload as a noop. Let's extend the table</p>
<p>____match____|__inhibit__|__next_table__|__payload__ condition | false | N/A | N/A miss | true | y | 0x0</p>
<p>Now, Tofino has corner cases that require the payload to be a non-zero value. Say I have the following P4 code: </p><pre class="fragment">field = register_action.execute(hash) // hash based index
b.apply();
</pre><p>In this program, if the condition is true, then an action that runs a register action addressed by hash is run. Now this action will be translated in our midend to a single table:</p>
<p>action compiler_generated_action() { field = register_action.execute(hash); }</p>
<p>table compiler_generated_table { actions = { compiler_generated_action; } default_action = compiler_generated_action; }</p>
<p>This is a keyless table, and thus will always miss. Thus if this table ever runs, the miss action will have to set up this register action's execution. The major problem is that any information from hash is only available on the hit pathway. Hash Distribution is only accessible on hit. This is a conflict, as a table that can only run the miss pathway must access something that is only accessible on hit.</p>
<p>The hardware workaround is to use a gateway. The gateway can be used to generate a "hit", which then is used to access the hardware pathway. This is basically the gateway running an action. The table in this case would be:</p>
<p>____match____|__inhibit__|__next_table__|__payload__ true | yes | b | 0x0</p>
<p>In this case, the table is executed by the gateway inhibiting. Inhibit in this case runs a table. The gateway must always match, as we unconditionally want to run the table. The all 0 payload is then intepreted by match central to execute the compiler_generated_action, rather than run a noop on the previous example.</p>
<p>Now let's extend the example, to further understanding:</p>
<p>if (condition) { field = register_action.execute(hash) // hash based index b.apply(); } else { c.apply(); }</p>
<p>The gateway rows become:</p>
<p>____match____|__inhibit__|__next_table__|__payload__ condition | yes | b | 0x3 miss | no | N/A | N/A</p>
<p>gateway format : { action(0) : 0..0, meter_pfe(0) : 1..1 }</p>
<p>Now, when the condition is true, we want the register action to run. We run by inhibiting the table. When the condition is false, we want the register action to not run. The table will be run, and then the miss pathway will set the payload. The gateway payload is not necessary for this case, as on the miss the hit pathway will not run, and the input to the table will never be all 0. However, in order to match what is done for all other gateway examples (i.e. linking a table with a gateway preserves handling the all 0 input being a noop), the payload value was added.</p>
<p>This feature has now been extended in Tofino2. The major difference between Tofino and Tofino2 is that in Tofino, there is only a single entry allowed in the gateway format. In Tofino2, up to 5 entries are allowed in the format. This allows for separate behavior per entry.</p>
<p>Say for instance, I had the following program:</p>
<p>if (field == 3) field1 = register_action1.execute(hash); -&gt; action compiler_generated_act1; else if (field == 7) field2 = register_action2.execute(hash); -&gt; action compiler_generated_act2; b.apply();</p>
<p>where each of the register actions correspond to different stateful instructions on the same stateful ALU. This program requires two gateways in Tofino, where it could be done in a single gateway in Tofino2. Each stateful ALU execution requires a separate meter_type. Thus if I wanted to do this in a gateway:</p>
<p>____match____|__inhibit__|__next_table__|__payload__ field == 3 | yes | b | payload1 field == 7 | yes | b | payload2 miss | no | N/A | N/A</p>
<p>gateway_format = { action(0) : 0..1, meter_pfe(0) : 2..2, meter_type(0) : 3..5, action(1) : 6..7, meter_pfe(1) : 8..8, meter_type(1) : 9..11 }</p>
<p>Because the action that would be run (setting field1 or field2 would be different), as well as the register action's stateful instruction differing, both of the entries require a different payload. However, on Tofino, only one entry is allowed for the gateway payload</p>
<p>On Tofino2, however, multiple entries are allowed in the gateway format. This is because the gateway has a separate shift per entry. The register .*_exact_shiftcount has up to 5 entries per exact match table. A gateway has 5 entries, so in Tofino2, the exact_shiftcount was also made accessible to the gateway. Thus now a gateway can support different execution per gateway match.</p>
<p>The purpose of this pass is to find tables that can be converted to this type of gateway and convert them if table placement wishes to do so. </p>

</div>
</div>
<a id="a99681f18bb90021f79a05f52b1827647" name="a99681f18bb90021f79a05f52b1827647"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a99681f18bb90021f79a05f52b1827647">&#9670;&#160;</a></span>convert_to_gateway()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">IR::MAU::Table * FindPayloadCandidates::convert_to_gateway </td>
          <td>(</td>
          <td class="paramtype">const IR::MAU::Table *</td>          <td class="paramname"><span class="paramname"><em>tbl</em></span></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>A table may originally have next table propagation information in the next table map that now has to be updated for this program.</p>
<p>Essentially each gateway row (in order to have an entry in to the gateway_payload map), will have a unique tag: $entry#. The miss entry will currently have a $miss entry.</p>
<p>If the table is a hit or miss, then all entries that run the gateway payload will tie to the hit pathway, while the entry for the miss pathway goes through $miss. With an action_chain, because the actions of each entry is known ahead of time, each gateway entry can reflect that in the code. If no control flow from this table exists, just create empty entries.</p>

</div>
</div>
<a id="a2ae340a7b20b6d4e5e0e1c56cf5b721c" name="a2ae340a7b20b6d4e5e0e1c56cf5b721c"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a2ae340a7b20b6d4e5e0e1c56cf5b721c">&#9670;&#160;</a></span>determine_payload()</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="class_p4_1_1bitvec.html">bitvec</a> FindPayloadCandidates::determine_payload </td>
          <td>(</td>
          <td class="paramtype">const IR::MAU::Table *</td>          <td class="paramname"><span class="paramname"><em>tbl</em></span>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const <a class="el" href="struct_table_resource_alloc.html">TableResourceAlloc</a> *</td>          <td class="paramname"><span class="paramname"><em>alloc</em></span>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const IR::MAU::Table::Layout *</td>          <td class="paramname"><span class="paramname"><em>layout</em></span>&#160;)</td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">static</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">
<p>This is to determine the value that goes onto the payload_value of a gateway. Can be used for both Tofino and Tofino2 gateways, both pre and post table placement. This is currently done in the memories allocation, as this is when we write the Memories::Use object.</p>
<p>Will allow gateway variables such as:</p>
<ul>
<li>action</li>
<li>immediate</li>
<li>stats_addr</li>
<li>stats_pfe</li>
<li>meter_addr</li>
<li>meter_pfe</li>
<li>meter_type </li>
</ul>

</div>
</div>
</div><!-- contents -->
</div><!-- doc-content -->
<!-- HTML footer for doxygen 1.12.0-->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="class_find_payload_candidates.html">FindPayloadCandidates</a></li>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.12.0 </li>
  </ul>
</div>
</body>
</html>
