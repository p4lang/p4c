<!-- HTML header for doxygen 1.12.0-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.12.0"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>P4 Compiler Documentation (P4C): P4C Repository Organization</title>
<link rel="icon" href="p4-fav.svg" type="image/x-icon" />
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<!--  Add link to paragraphs   -->
<script type="text/javascript" src="doxygen-awesome-paragraph-link.js"></script>
<script type="text/javascript">
  DoxygenAwesomeParagraphLink.init()
</script>
<!-- Add copy button to code fragments  -->
<script type="text/javascript" src="doxygen-awesome-fragment-copy-button.js"></script>
<script type="text/javascript">
  DoxygenAwesomeFragmentCopyButton.init()
</script>
<!-- Add dark mode toggle -->
<script type="text/javascript" src="doxygen-awesome-darkmode-toggle.js"></script>
<script type="text/javascript">
  DoxygenAwesomeDarkModeToggle.init()
</script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="cookie.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="doxygen-awesome.css" rel="stylesheet" type="text/css"/>
<link href="doxygen-awesome-sidebar-only.css" rel="stylesheet" type="text/css"/>
<link href="doxygen-awesome-sidebar-only-darkmode-toggle.css" rel="stylesheet" type="text/css"/>
<link href="cards.css" rel="stylesheet" type="text/css"/>
<link href="flow.css" rel="stylesheet" type="text/css"/>
<link href="p4c_custom.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectlogo"><img alt="Logo" src="p4-logo.png"/></td>
  <td id="projectalign">
   <div id="projectname">P4C
   </div>
   <div id="projectbrief">The P4 Compiler</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.12.0 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() { codefold.init(0); });
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search',true);
  $(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function(){initNavTree('repository_structure.html',''); initResizable(true); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">P4C Repository Organization</div></div>
</div><!--header-->
<div class="contents">
<div class="toc"><h3>Table of Contents</h3>
<ul>
  <li class="level1">
    <a href="#compiler-source-code-organization">Compiler source code organization</a>
  </li>
  <li class="level1">
    <a href="#additional-documentation">Additional documentation</a>
  </li>
  <li class="level1">
    <a href="#writing-documentation">Writing documentation</a>
    <ul>
      <li class="level2">
        <a href="#cc-documentation-comments-style-guide">C/C++ Documentation Comments Style Guide</a>
      </li>
      <li class="level2">
        <a href="#building-the-doxygen-documentation">Building the Doxygen documentation</a>
        <ul>
          <li class="level3">
            <a href="#doxygen-comments-style-guide">Doxygen Comments Style Guide</a>
          </li>
        </ul>
      </li>
      <li class="level2">
        <a href="#git-usage">Git usage</a>
      </li>
      <li class="level2">
        <a href="#debugging">Debugging</a>
      </li>
      <li class="level2">
        <a href="#testing">Testing</a>
        <ul>
          <li class="level3">
            <a href="#adding-new-test-data">Adding new test data</a>
          </li>
        </ul>
      </li>
      <li class="level2">
        <a href="#coding-conventions">Coding conventions</a>
      </li>
      <li class="level2">
        <a href="#compiler-driver">Compiler Driver</a>
      </li>
    </ul>
  </li>
</ul>
</div>
<div class="textblock"><p>This folder contains documentation for the P4_16 prototype compiler. The code and documentation are hosted in the <a href="https://github.com/p4lang/p4c">p4c repository</a>.</p>
<h1><a class="anchor" id="compiler-source-code-organization"></a>
Compiler source code organization</h1>
<div class="fragment"><div class="line">p4c</div>
<div class="line">├── build                          -- recommended place to build binary</div>
<div class="line">├── backends          </div>
<div class="line">│   ├── bmv2                       -- behavioral model version 2 (switch simulator) back end</div>
<div class="line">│   ├── common                     -- code shared by multiple back ends</div>
<div class="line">│   ├── dpdk                       -- translates P4 code to DPDK instructions</div>
<div class="line">│   ├── ebpf                       -- extended Berkeley Packet Filters back end</div>
<div class="line">│   ├── graphs                     -- backend that can draw graphiz graphs of P4 programs</div>
<div class="line">│   ├── p4test                     -- &quot;fake&quot; back end for testing</div>
<div class="line">│   ├── p4tools                    -- testing library for different static analysis tools</div>
<div class="line">│   ├── tc                         -- translates P4 code to Linux TC rules</div>
<div class="line">│   └── ubpf                       -- translates P4 programs to uBPF code</div>
<div class="line">├── bazel                          -- bazel files for building p4c</div>
<div class="line">|   └──example                     -- basic Bazel project example using p4c</div>
<div class="line">├── cmake                          -- CMake support and build systems </div>
<div class="line">├── control-plane                  -- control plane API</div>
<div class="line">|   └──google/rpc                  -- Definitions of Google Protobuf APIs.</div>
<div class="line">├── debian                         -- Debian/Ubuntu packaging files</div>
<div class="line">│   └── source/format              -- Specification of the packaging format</div>
<div class="line">├── docs                           -- documentation</div>
<div class="line">│   ├── assets                     -- p4 logos in PNG and SVG formats</div>
<div class="line">│   └── doxygen                    -- documentation generation support</div>
<div class="line">├── frontends</div>
<div class="line">│   ├── common                     -- common front end code</div>
<div class="line">│   ├── p4-14                      -- P4_14 front end</div>
<div class="line">│   ├── p4                         -- P4_16 front end</div>
<div class="line">│   └── parsers                    -- parser and lexer code for P4_14 and P4_16</div>
<div class="line">├── ir                             -- core internal representation</div>
<div class="line">├── lib                            -- common utilities (libp4toolkit.a)</div>
<div class="line">├── midend                         -- code that may be useful for writing mid-ends</div>
<div class="line">├── p4include                      -- standard P4 files needed by the compiler (e.g., core.p4)</div>
<div class="line">│   ├── bmv2                       -- bmv2 specific customizations of psa.p4 include file</div>
<div class="line">│   ├── dpdk                       -- dpdk specific pna.p4 &amp; psa.p4</div>
<div class="line">│   └── tc                         -- tc specific pna</div>
<div class="line">├── test                           -- test code</div>
<div class="line">│   └── gtest                      -- unit test code written using gtest</div>
<div class="line">├── testdata                       -- test inputs and reference outputs</div>
<div class="line">│   ├───extern_modules             -- Extern module input test programs</div>
<div class="line">│   ├───p4_14_errors               -- P4_14 negative input test programs</div>
<div class="line">│   ├───p4_14_errors_outputs       -- Expected outputs from P4_14 negative tests</div>
<div class="line">│   ├───p4_14_samples              -- P4_14 input test programs</div>
<div class="line">│   ├───p4_14_samples_outputs      -- Expected outputs from P4_14 tests</div>
<div class="line">|   ├── p4_16_samples              -- P4_16 input test programs</div>
<div class="line">|   ├── p4_16_samples_outputs      -- Expected outputs from P4_16 tests</div>
<div class="line">│   ├───p4_16_bmv_errors           -- P4_16 negative input tests for the bmv2 backend</div>
<div class="line">│   ├───p4_16_dpdk_errors          -- P4_16 negative input tests for the dpdk backend</div>
<div class="line">│   ├───p4_16_dpdk_errors_outputs  -- Expected outputs from dpdk negative tests </div>
<div class="line">│   ├───p4_16_ebpf_errors          -- P4_16 negative input tests for the ebpf backend</div>
<div class="line">│   ├───p4_16_ebpf_errors_outputs  -- Expected outputs from edpf negative tests </div>
<div class="line">|   ├── p4_16_errors               -- P4_16 negative input test programs</div>
<div class="line">|   ├── p4_16_errors_outputs       -- Expected outputs from P4_16 negative tests</div>
<div class="line">│   ├───p4_16_pna_errors           -- P4_16 negative input test programs for pna</div>
<div class="line">│   ├───p4_16_pna_errors_outputs   -- Expected outputs from P4_16 pna negative tests</div>
<div class="line">│   ├───p4_16_psa_errors           -- P4_16 negative input test programs for psa</div>
<div class="line">│   ├───p4_16_psa_errors_outputs   -- Expected outputs from P4_16 psa negative tests</div>
<div class="line">│   ├───p4_16_samples              -- P4_16 input test programs</div>
<div class="line">│   ├───p4_16_samples_outputs      -- Expected outputs from P4_16 tests</div>
<div class="line">│   ├───p4tc_samples               -- P4 traffic control sample input test programs</div>
<div class="line">│   ├───p4tc_samples_outputs       -- Expected outputs from P4 traffic control tests</div>
<div class="line">│   └───v1_1_samples               -- P4 v1.1 sample programs</div>
<div class="line">└── tools                          -- external programs used in the build/test process</div>
<div class="line">    ├── ci-ptf                     -- scripts to run PSA PTF tests</div>
<div class="line">    ├── debian-build               -- resources and scripts for creating Ubuntu (or Debian) packages</div>
<div class="line">    ├── driver                     -- P4C compiler driver: a script that invokes various compilers</div>
<div class="line">    ├── hooks                      -- useful git hooks for development</div>
<div class="line">    ├── ir-generator               -- code to generate the P4C IR from .def files</div>
<div class="line">    ├── iwyu_mappings              -- mappings used by the Include What You Use (IWYU) tool for analyzing #include directives in C and C++ source files</div>
<div class="line">    ├── ptf                        -- utilities for the Packet Test Framework (PTF)</div>
<div class="line">    └── stf                        -- utilities for the Simple Test Framework (STF)</div>
</div><!-- fragment --><h1><a class="anchor" id="additional-documentation"></a>
Additional documentation</h1>
<ul>
<li>the P4_14 and P4_16 languages are described in their respective specifications, available <a href="https://p4.org/specs">here</a>.</li>
<li>the core design of the compiler intermediate representation (IR) and the visitor patterns are briefly described in IR</li>
<li>The <a href="https://github.com/p4lang/p4c/blob/main/docs/migration-guide.pptx">migration guide</a> describes how P4_14 (v1.0) programs are translated into P4_16 programs</li>
<li>The <a href="https://github.com/p4lang/p4c/blob/main/docs/compiler-design.pptx">compiler design</a> describes the salient features of the compiler design and implementation; this document has several subsections:<ul>
<li>Compiler goals</li>
<li>Compiler architecture</li>
<li>Source code organization</li>
<li>IR and visitors; recipes</li>
<li>A guide to the existing passes</li>
<li>Discussion of the three sample back-ends</li>
</ul>
</li>
<li>Specific back-ends may have their own documentation; check the <code>extensions</code> sub-folders, and also the following supplied back-ends:<ul>
<li>BMv2</li>
<li>eBPF</li>
<li>P4Tools</li>
</ul>
</li>
<li>Check out the <a href="https://github.com/TakeshiTseng/IntelliJ-P4-Plugin">IntelliJ P4 plugin</a></li>
</ul>
<h1><a class="anchor" id="writing-documentation"></a>
Writing documentation</h1>
<p>Documenting the workings of the compiler is a never-ending (many times overlooked) job. We can always write better documentation!</p>
<p>In P4C, documentation is generated using Doxygen. The generated documentation depends on <a href="https://github.com/jothepro/doxygen-awesome-css">Doxygen Awesome CSS</a>. The documentation is dynamically updated and deployed on <a href="https://p4lang.github.io/p4c/">GitHub Pages</a>.</p>
<p>Documentation is generated from two main sources: README files distributed across the repository and comments within the code. The README files are tagged with documentation inclusion notes to indicate their integration into the P4 compiler documentation.</p>
<p>Code comments should capture the main intent of the implementation and the "why", rather than the "how". The how can be read from the code, however, documenting the reasons why a certain implementation was chosen will help other contributors understand the design choices and enable them to reuse your code. Also important in the context of the compiler is to document the invariants for each pass (or groups of passes), since it is likely that other developers will need to insert additional passes, and they should understand the effects that the pass ordering has on the AST.</p>
<p>Documentation in the markup documents is intended for higher level design documentation. The files will be automatically captured in the documentation in the order implied by their naming: XX_my_doc.md where XX is a number between 02-99. Currently, 00_revision_history.md contains the documentation revision history, and 01_overview.md is the overview of the compiler goals and architecture.</p>
<h2><a class="anchor" id="cc-documentation-comments-style-guide"></a>
C/C++ Documentation Comments Style Guide</h2>
<ul>
<li>Use triple slashes <code>///</code> for documenting functions and classes in files.</li>
<li>Double slashes <code>//</code> should be used for "internal" comments within functions.</li>
<li>Double slashes <code>//</code> should be used for inline comment.</li>
<li>For rare occasions such as adding comments to multi-line macros, you may use <code>/* ... */</code> style comments.</li>
<li>Formatting:<ul>
<li>There should be no space at the end of the comment.</li>
<li>First letter of the comment should be a capital letter.</li>
<li>Each comment should end with a period.</li>
</ul>
</li>
</ul>
<h2><a class="anchor" id="building-the-doxygen-documentation"></a>
Building the Doxygen documentation</h2>
<ul>
<li>Doxygen is configured in <code>docs/doxygen/doxygen.cfg</code>.</li>
<li>The main HTML page is configured in <code>docs/doxygen/Doxymain.md</code>:<ul>
<li>CSS for the card effect is in <code>docs/assets/css/card.css</code>.</li>
<li>The effect for the Easter egg toggle is defined in <code>docs/assets/css/flow.css</code>.</li>
<li>The homepage P4C architecture is rendered using <code>docs/assets/architecture_unanimated.html</code>, with the editable draw file available at <code>docs/assets/Architecture.drawio</code>.</li>
</ul>
</li>
<li>Add pages and subpages manually to the sidebar (see <code>docs/doxygen/p4c_layout.xml</code>).</li>
<li>TOCs in markdown files are created with the <code>[TOC]</code> command.</li>
<li>The base style for Doxygen Awesome is described in the <a href="https://jothepro.github.io/doxygen-awesome-css/">Doxygen Awesome Documentation</a> and the updated color scheme is defined in <a href="https://github.com/p4lang/p4c/blob/main/docs/assets/css/p4c_custom.css"><code>docs\assets\css\p4c_custom.css</code></a>.</li>
</ul>
<h3><a class="anchor" id="doxygen-comments-style-guide"></a>
Doxygen Comments Style Guide</h3>
<ul>
<li>Comment Markup and Documentation Commands<ul>
<li><code>&lt;!-- ... --&gt;</code> is used for adding documentation inclusion notes. This content is hidden from both the rendered Markdown and Doxygen, but visible in the raw view on GitHub.</li>
<li><code>...</code> hides commands from GitHub’s Markdown rendering but provides instructions to Doxygen. For example: <div class="fragment"><div class="line">&lt;!--!</div>
<div class="line">\page changelog Releases</div>
<div class="line">--&gt;</div>
</div><!-- fragment --></li>
<li><code>\internal</code> and <code>\endinternal</code> commands within comments can be used to hide information from Doxygen while still displaying it on GitHub. <div class="fragment"><div class="line">&lt;!--!</div>
<div class="line">\internal</div>
<div class="line">--&gt;</div>
<div class="line">This section is hidden from Doxygen but will be visible on GitHub.</div>
<div class="line">&lt;!--!</div>
<div class="line">\endinternal</div>
<div class="line">--&gt;</div>
</div><!-- fragment --></li>
</ul>
</li>
</ul>
<p>Happy writing! Should you have any questions, please don't hesitate to ask.</p>
<h2><a class="anchor" id="git-usage"></a>
Git usage</h2>
<ul>
<li>To contribute: fork the p4lang/p4c repository on github. <a href="https://help.github.com/articles/fork-a-repo/">Detailed instructions on forking a repository</a>.</li>
<li>To merge a forked repository with the latest changes in the source use:</li>
</ul>
<div class="fragment"><div class="line">git fetch upstream</div>
<div class="line">git rebase upstream/main</div>
<div class="line">git push -f</div>
</div><!-- fragment --><ul>
<li>After committing changes, create a pull request (using the github web UI)</li>
<li>Follow these <a class="el" href="contribute.html#git-commits-and-pull-requests">guidelines</a> to write commit messages and open pull requests.</li>
<li>For every pull request opened, a standard set of CI tests will run automatically. If any of these fail, look at the Github page for your pull request for the list of tests that have been run. There should be "Details" links there for any tests that have failed. Ask for help via messages in comments on your PR if you are not able to determine the cause of the failures.</li>
<li>There are several CI tests that are not run on every pull request automatically, but only via following the steps below, in order to reduce the compute resources used on every pull request. If you wish to run one or more of these, look through the list of Github labels for the p4c project <a href="https://github.com/p4lang/p4c/labels">here</a> for labels whose name begins with "run-". Add one or more of those labels to your PR. On all future pushes to the branch of that PR, those additional CI runs should run.</li>
</ul>
<h2><a class="anchor" id="debugging"></a>
Debugging</h2>
<ul>
<li>To debug the build process you can run <code>make V=1</code></li>
<li>The top-level <code>.gdbinit</code> file has some additional pretty-printers. If you start gdb in this folder (p4c), then it should be automatically used. Otherwise you can run at the gdb prompt <code>source path-to-p4c/.gdbinit</code>.</li>
<li>To debug the compiler parser you can set the environment variable <code>YYDEBUG</code> to 1</li>
<li>The following <code>IR::Node</code> methods can be used to print nice representations of compiler data structures:<ul>
<li><code>void dbprint(std::ostream&amp; out) const</code>: this method is used when logging information. It should print useful debug information, intended for consumption by compiler writers.</li>
<li><code>cstring toString() const</code>: this method is used when reporting error messages to compiler users. It should only display information that is related to the P4 user program, and never internal compiler data structures.</li>
</ul>
</li>
<li>Use the LOG* macros for writing debug messages. gdb misbehaves frequently, so log messages are the best way to debug your programs. The number in the function name is the debug verbosity. The higher, the less important the message. This macro invokes the <code>dbprint</code> method on objects that provide it. Here is an example usage: <code>LOG1("Replacing " &lt;&lt; id &lt;&lt; " with " &lt;&lt; newid);</code></li>
<li>Keep the compiler output deterministic; watch for iterators over sets and maps, which may introduce non-deterministic orders. Use our own <code>ordered_map</code> and <code>ordered_set</code> if you iterate, to keep iteration order deterministic.</li>
<li><p class="startli">You can control the logging level per compiler source-file with the <code>-T</code> compiler command-line flag. The flag is followed by a list of file patterns and a numeric level after a colon <code>:</code>. This flag enables all logging messages above the specified level for all compiler source files that match the file pattern.</p>
<p class="startli">For example, to enable logging in file <code>node.cpp</code> above level 1, and in file <code>pass_manager.cpp</code> above level 2, use the following compiler command-line option: <code>-Tnode:1,pass_manager:2</code></p>
<p class="startli">To execute LOG statements in a header file you must supply the complete name of the header file, e.g.: <code>-TfunctionsInlining.h:3</code>.</p>
</li>
</ul>
<h2><a class="anchor" id="testing"></a>
Testing</h2>
<p>The testing infrastructure is based on small python and shell scripts.</p>
<ul>
<li>To run tests execute <code>make check -j3</code><ul>
<li>There should be no FAIL or XPASS tests.</li>
<li>XFAIL tests are tolerated only transiently.</li>
</ul>
</li>
<li>To run a subset of tests execute <code>make check-PATTERN</code>. E.g., <code>make check-p4</code>.</li>
<li>To rerun the tests that failed last time run <code>make recheck</code></li>
<li>To run a single test case execute &lsquo;ctest --output-on-failure -R &rsquo;&lt;test&gt;'<code>. Example:</code>ctest &ndash;output-on-failure -R 'psa-switch-expression-without-default'`</li>
<li>Add unit tests in <code>test/gtest</code></li>
</ul>
<p>Test programs with file names ending in <code>-bmv2.p4</code> or <code>-ebpf.p4</code> may have an STF (Simple Test Framework) file with file name suffix <code>.stf</code> associated with them. If the machine on which you are running has a copy of <code>simple_switch</code> or the EBPF software switch installed, not only will those programs be compiled for those targets, but also table entries optionally specified in the STF file will be installed, and input packets will be sent to the data plane and output packets checked against expected packets in the STF file.</p>
<p>When pull requests are created on the p4c Github repository, the changes are built, and the tests executed via <code>make check</code>. These tests are run with a "recently built" version of <code>simple_switch</code> from the <a href="https://github.com/p4lang/behavioral-model">p4lang/behavioral-model</a> repository, but it can be several hours old. If you are working on P4C features that rely on newly committed changes to <code>simple_switch</code> you can find out which <code>simple_switch</code> version these P4C automated tests are using at the link below:</p>
<ul>
<li><a href="https://hub.docker.com/r/p4lang/behavioral-model/builds">https://hub.docker.com/r/p4lang/behavioral-model/builds</a></li>
</ul>
<h3><a class="anchor" id="adding-new-test-data"></a>
Adding new test data</h3>
<p>To add a new input test with a sample P4 code file (under <code>testdata/p4_16_samples/</code> for example), one needs to:</p>
<ul>
<li>Add the <code>*.p4</code> file to the <code>testdata/p4_16_samples/</code> directory. The file name might determine which test suite this test belongs to. Those are determined by cmake commands.<ul>
<li>For example, <a href="https://github.com/p4lang/p4c/blob/de2eaa085152abd0690660fbe561eaf5db7b2bf7/backends/p4test/CMakeLists.txt#L63">any P4 file under <code>testdata/p4_16_samples/</code></a> belongs to the <a href="https://github.com/p4lang/p4c/blob/de2eaa085152abd0690660fbe561eaf5db7b2bf7/backends/p4test/CMakeLists.txt#L113"><code>p4</code> test suite</a> (meaning it will run with <code>make check-p4</code>).</li>
<li><a href="https://github.com/p4lang/p4c/blob/de2eaa085152abd0690660fbe561eaf5db7b2bf7/backends/bmv2/CMakeLists.txt#L127">File ending with <code>*-bmv2.p4</code></a> also belongs to the <a href="https://github.com/p4lang/p4c/blob/de2eaa085152abd0690660fbe561eaf5db7b2bf7/backends/bmv2/CMakeLists.txt#L200"><code>bmv2</code> test suite</a> (meaning it will run with <code>make check-bmv2</code>).</li>
</ul>
</li>
<li>Then generate reference outputs:<ul>
<li>For a frontend-only test, you can run <code>../backends/p4test/run-p4-sample.py . -f ../testdata/p4_16_samples/some_name.p4</code>. Note that this command needs to run under the <code>build/</code> directory. The test will fail if the test output is missing or does not match with the existing reference outputs. Toggling the <code>-f</code> flag will force the script to produce new reference outputs, which can, and should be committed, along with the changes that caused the output change.</li>
<li>For a test targeting bmv2 backend, the corresponding command is <code>../backends/bmv2/run-bmv2-test.py</code>.</li>
<li>If you have many reference outputs to add/update, you could also do <code>P4TEST_REPLACE=True make check</code> (or <code>make check-*</code>) to update all tests.</li>
</ul>
</li>
<li>The reference files for each test will be updated after running the tests.</li>
</ul>
<h2><a class="anchor" id="coding-conventions"></a>
Coding conventions</h2>
<ul>
<li>Coding style is guided by the following rules.</li>
<li>We generally follow the <a href="https://google.github.io/styleguide/cppguide.html">Google C++ Style Guide</a>. This is partially enforced by <code>cpplint</code> and <code>clang-format</code> and their respective configuration files. We have customized Google's <code>cpplint.py</code> tool for our purposes. The tool can be invoked with <code>make cpplint</code>. To be able to run <code>clang-format</code> on Ubuntu 20.04, install it with <code>pip3 install --user clang-format</code>. Do not use the Debian package. Both tools run in a git hook and as part of CI.</li>
<li>Commenting Style is guided by the following rules.</li>
<li>Watch out for <code>const</code>; it is very important.</li>
<li>Use <code>override</code> whenever possible (new GCC versions enforce this).</li>
<li>Never use <code>const_cast</code> and <code>reinterpret_cast</code>.</li>
<li>Lines are wrapped at 100 characters.</li>
<li>Indents are four spaces. Tab characters should not be used for indenting.</li>
<li>The C++ code is written to use a garbage-collector<ul>
<li>do not use any smart pointers, just raw pointers</li>
</ul>
</li>
<li>Use our implementations and wrappers instead of standard classes:<ul>
<li>Use <code>cstring</code> for constant strings. For java programmers, <code>cstring</code> should be used where you would use java.lang.String, and <code>std::string</code> should be used where you would use StringBuilder or StringBuffer.</li>
<li>Use the <code>BUG()</code> macro to signal an exception. This macro is guaranteed to throw an exception.</li>
<li>Use <code>CHECK_NULL()</code> to validate that pointers are not nullptr.</li>
<li>Use <code>BUG_CHECK()</code> instead of <code>assert</code>, and always supply an informative error message.</li>
<li>Use <code>error()</code> and <code>warning()</code> for error reporting. See the <a class="el" href="contribute.html#handling-errors">guidelines</a> for more details.</li>
<li>Use <code>LOGn()</code> for log messages &ndash; the <code>n</code> is an integer constant for verbosity level. These can be controlled on a per-source-file basis with the -T option. LOG1 should be used for general messages, so that running with -T*:1 (turning on all LOG1 messages) is not too overwhelming. LOG2 should be used to print information about the results of a module that later passes may need to debug them. Details of what a module or pass is doing and looking at (only of interest when debugging that code) should be at LOG4 or higher.</li>
<li>Use the <code>vector</code> and <code>array</code> wrappers for <code>std::vector</code> and <code>std::array</code> (these do bounds checking on all accesses).</li>
<li>Use <code>ordered_map</code> and <code>ordered_set</code> when you need to iterate; they provide deterministic iterators.</li>
</ul>
</li>
</ul>
<h2><a class="anchor" id="compiler-driver"></a>
Compiler Driver</h2>
<p><b>p4c</b> is a compiler driver. The goal is to provide a consistent user interface across different p4 backends and work flows. The compiler driver is written in Python. It can be extended for custom backends.</p>
<p>The usage of the driver is as follows: </p><div class="fragment"><div class="line">usage: p4c [-h] [-V] [-v] [-###] [-Xpreprocessor &lt;arg&gt;] [-Xp4c &lt;arg&gt;]</div>
<div class="line">           [-Xassembler &lt;arg&gt;] [-Xlinker &lt;arg&gt;] [-b BACKEND] [-E] [-e] [-S]</div>
<div class="line">           [-c] [-x {p4-14,p4-16}] [-I SEARCH_PATH] [-o PATH] [--target-help]</div>
<div class="line">           [source_file]</div>
<div class="line"> </div>
<div class="line">positional arguments:</div>
<div class="line">  source_file           File to compile</div>
<div class="line"> </div>
<div class="line">optional arguments:</div>
<div class="line">  -h, --help            show this help message and exit</div>
<div class="line">  -V, --version         show version and exit</div>
<div class="line">  -v                    verbose</div>
<div class="line">  -###                  print (but do not run) the commands</div>
<div class="line">  -Xpreprocessor &lt;arg&gt;  Pass &lt;arg&gt; to the preprocessor</div>
<div class="line">  -Xp4c &lt;arg&gt;           Pass &lt;arg&gt; to the compiler</div>
<div class="line">  -Xassembler &lt;arg&gt;     Pass &lt;arg&gt; to the assembler</div>
<div class="line">  -Xlinker &lt;arg&gt;        Pass &lt;arg&gt; to the linker</div>
<div class="line">  -b BACKEND            specify target backend</div>
<div class="line">  -E                    Only run the preprocessor</div>
<div class="line">  -e                    Skip the preprocessor</div>
<div class="line">  -S                    Only run the preprocess and compilation steps</div>
<div class="line">  -c                    Only run preprocess, compile, and assemble steps</div>
<div class="line">  -x {p4-14,p4-16}      Treat subsequent input file as having type language.</div>
<div class="line">  -I SEARCH_PATH        Add directory to include search path</div>
<div class="line">  -o PATH               Write output to the provided path</div>
<div class="line">  --target-help         Display target specific command line options.</div>
</div><!-- fragment --><p>To extend the driver, user needs to create a configuration file and add it to the <code>p4c_PYTHON</code> makefile variable.</p>
<div class="fragment"><div class="line"># In your custom Makefile.am</div>
<div class="line"> </div>
<div class="line">p4c_PYTHON += p4c.custom.cfg</div>
</div><!-- fragment --><p>There is an global variable <code>config</code> in the <code>p4c</code> compiler driver that stores the build steps for a particular target. By default, the bmv2 and ebpf backends are supported. Each backend is identified with a triplet: <b>target-arch-vendor</b>. For example, the default bmv2 backend is identified as <code>bmv2-ss-p4org</code>. Users may choose to implement different architectures running on the same target, and they should configure the compilation flow as follows:</p>
<div class="fragment"><div class="line">config.add_preprocessor_options(&quot;bmv2-newarch-p4org&quot;, &quot;-E&quot;)</div>
<div class="line">config.add_compiler_options(&quot;bmv2-newarch-p4org&quot;, &quot;{}/{}.o&quot;.format(output_dir, source_basename))</div>
<div class="line">config.add_assembler_options(&quot;bmv2-newarch-p4org&quot;, &quot;{}/{}.asm&quot;.format(output_dir, source_basename))</div>
<div class="line">config.add_linker_options(&quot;bmv2-newarch-p4org&quot;, &quot;{}/{}.json&quot;.format(output_dir, source_basename))</div>
<div class="line"> </div>
<div class="line">config.add_toolchain(&quot;bmv2-newarch-p4org&quot;, {&quot;preprocessor&quot;: &quot;cc&quot;, &quot;compiler&quot;: &quot;p4c-bm2-newarch&quot;, &quot;assembler&quot;: &quot;&quot;, &quot;linker&quot;: &quot;&quot;})</div>
<div class="line">config.add_compilation_steps([&quot;preprocessor&quot;, &quot;compiler&quot;])</div>
<div class="line">config.target.append(&quot;bmv2-newarch-p4org&quot;)</div>
</div><!-- fragment --><p>After adding the new configuration file, rerun <code>bootstrap.sh</code></p>
<p>For testing purposes, <code>p4c</code> will be installed in the build/ directory when executing <code>make</code>. Users can install <code>p4c</code> to other system path by running <code>make install</code> </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- HTML footer for doxygen 1.12.0-->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.12.0 </li>
  </ul>
</div>
</body>
</html>
