<!-- HTML header for doxygen 1.12.0-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.12.0"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>P4 Compiler Documentation (P4C): Action Phv Constraint Solvers</title>
<link rel="icon" href="p4-fav.svg" type="image/x-icon" />
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<!--  Add link to paragraphs   -->
<script type="text/javascript" src="doxygen-awesome-paragraph-link.js"></script>
<script type="text/javascript">
  DoxygenAwesomeParagraphLink.init()
</script>
<!-- Add copy button to code fragments  -->
<script type="text/javascript" src="doxygen-awesome-fragment-copy-button.js"></script>
<script type="text/javascript">
  DoxygenAwesomeFragmentCopyButton.init()
</script>
<!-- Add dark mode toggle -->
<script type="text/javascript" src="doxygen-awesome-darkmode-toggle.js"></script>
<script type="text/javascript">
  DoxygenAwesomeDarkModeToggle.init()
</script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="cookie.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="doxygen-awesome.css" rel="stylesheet" type="text/css"/>
<link href="doxygen-awesome-sidebar-only.css" rel="stylesheet" type="text/css"/>
<link href="doxygen-awesome-sidebar-only-darkmode-toggle.css" rel="stylesheet" type="text/css"/>
<link href="cards.css" rel="stylesheet" type="text/css"/>
<link href="flow.css" rel="stylesheet" type="text/css"/>
<link href="p4c_custom.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectlogo"><img alt="Logo" src="p4-logo.png"/></td>
  <td id="projectalign">
   <div id="projectname">P4C
   </div>
   <div id="projectbrief">The P4 Compiler</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.12.0 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() { codefold.init(0); });
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search',true);
  $(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function(){initNavTree('md__2home_2runner_2work_2p4c_2p4c_2backends_2tofino_2bf-p4c_2phv_2solver_2_r_e_a_d_m_e.html',''); initResizable(true); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">Action Phv Constraint Solvers</div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a class="anchor" id="action-phv-constraint-solvers"></a></p>
<p>Action constraint solvers are used to validate PHV packing. When a candidate allocation list is proposed and passed to can_pack function in action phv constrait, a solver will be created to collect all move-based instructions for all actions related to fields in the candidate container. If both source and destination has been allocated, the solver will check and generate instruction based on the PHV allocation.</p>
<h1><a class="anchor" id="example-of-using-z3"></a>
Example of using Z3</h1>
<p>an example of using z3 to validate deposit field. Unfortunately it's about 20ms per invocation, which is too slow for us. </p><div class="fragment"><div class="line"> c++</div>
<div class="line">boost::optional&lt;Error&gt; ActionMoveSolver::run_deposit_field_z3_solver(</div>
<div class="line">    const ContainerID dest, const std::vector&lt;Assign&gt;&amp; src1,</div>
<div class="line">    const std::vector&lt;Assign&gt;&amp; src2) const {</div>
<div class="line">    const int width = specs_i.at(dest).size;</div>
<div class="line">    BUG_CHECK(width &lt;= 32, &quot;container larger than 32-bit is not supported&quot;);</div>
<div class="line">    const unsigned int all_ones_value = ((unsigned long long)1 &lt;&lt; width) - 1;</div>
<div class="line">    // pre-compute rot</div>
<div class="line">    int right_shift_val = right_rotate_offset(src1.front(), width);</div>
<div class="line">    // pre-compute mask l and h</div>
<div class="line">    int mask_l = width;</div>
<div class="line">    int mask_h = -1;</div>
<div class="line">    for (const auto&amp; assign : src1) {</div>
<div class="line">        mask_l = std::min(mask_l, assign.dst.range.lo);</div>
<div class="line">        mask_h = std::max(mask_h, assign.dst.range.hi);</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    z3::context ctx;</div>
<div class="line">    const auto rot = ctx.bv_val(right_shift_val, width);</div>
<div class="line">    const auto ones = ctx.bv_val(all_ones_value, width);</div>
<div class="line">    const auto s1 = ctx.bv_const(&quot;s1&quot;, width);</div>
<div class="line">    const auto s2 = ctx.bv_const(&quot;s2&quot;, width);</div>
<div class="line">    const auto mask = ctx.bv_const(&quot;mask&quot;, width);</div>
<div class="line">    const auto l = ctx.bv_val(mask_l, width);</div>
<div class="line">    const auto h = ctx.bv_val(mask_h, width);</div>
<div class="line">    const auto bv_sort = ctx.bv_sort(width);</div>
<div class="line">    const auto deposit_field = ctx.function(&quot;deposit_field&quot;, bv_sort, bv_sort, bv_sort);</div>
<div class="line"> </div>
<div class="line">    z3::solver s(ctx);</div>
<div class="line">    s.add(h &gt;= 0 &amp;&amp; h &lt; width &amp;&amp; l &gt;= 0 &amp;&amp; l &lt; width &amp;&amp; h &gt;= l);</div>
<div class="line">    s.add(mask == z3::shl(z3::lshr(ones, (width - 1 - h + l)), l));</div>
<div class="line">    s.add(</div>
<div class="line">        z3::forall(s1, s2,</div>
<div class="line">                   deposit_field(s1, s2) ==</div>
<div class="line">                       (((z3::lshr(s1, rot) | z3::shl(s1, width - rot)) &amp; mask) | (s2 &amp; (~mask)))));</div>
<div class="line"> </div>
<div class="line">    // except for unused bits, all other bits must be either</div>
<div class="line">    // (1) unchanged.</div>
<div class="line">    // (2) set by a correct bit from one of the source.</div>
<div class="line">    bitvec set_bits;</div>
<div class="line">    for (const auto&amp; assign : src1) {</div>
<div class="line">        // add src1 expected assertions.</div>
<div class="line">        const int dst_lo = assign.dst.range.lo;</div>
<div class="line">        const int dst_hi = assign.dst.range.hi;</div>
<div class="line">        set_bits.setrange(dst_lo, dst_hi - dst_lo + 1);</div>
<div class="line">        // for ad_or_const slices are aligned with destination.</div>
<div class="line">        int src_lo = assign.src.range.lo;</div>
<div class="line">        int src_hi = assign.src.range.hi;</div>
<div class="line">        if (assign.src.is_ad_or_const) {</div>
<div class="line">            src_lo = dst_lo;</div>
<div class="line">            src_hi = dst_hi;</div>
<div class="line">        }</div>
<div class="line">        s.add(z3::forall(</div>
<div class="line">            s1, s2, deposit_field(s1, s2).extract(dst_hi, dst_lo) == s1.extract(src_hi, src_lo)));</div>
<div class="line">    }</div>
<div class="line">    for (const auto&amp; assign : src2) {</div>
<div class="line">        BUG_CHECK(!assign.src.is_ad_or_const, &quot;deposit-field src2 cannot be ad_or_const&quot;);</div>
<div class="line">        const int dst_lo = assign.dst.range.lo;</div>
<div class="line">        const int dst_hi = assign.dst.range.hi;</div>
<div class="line">        set_bits.setrange(dst_lo, dst_hi - dst_lo + 1);</div>
<div class="line"> </div>
<div class="line">        const int src_lo = assign.src.range.lo;</div>
<div class="line">        const int src_hi = assign.src.range.hi;</div>
<div class="line">        s.add(z3::forall(</div>
<div class="line">            s1, s2, deposit_field(s1, s2).extract(dst_hi, dst_lo) == s2.extract(src_hi, src_lo)));</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    // In deposit-field, (src2 &amp; ~mask) will be the background of destination. So, if</div>
<div class="line">    // there is any bit that is not unused (occupied by some non-mutex fields) and not set</div>
<div class="line">    // it cannot be changed. The only possible case that it will not be changed is</div>
<div class="line">    // when src2 and dest are the same container.</div>
<div class="line">    bool require_src2_be_dest = false;</div>
<div class="line">    const auto&amp; unused_bits = specs_i.at(dest).unused;</div>
<div class="line">    for (int i = 0; i &lt; width; i++) {</div>
<div class="line">        // bits occupied by other field not involved in this action.</div>
<div class="line">        // It&#39;s safe to assume that those bits are from s2, as long as</div>
<div class="line">        // we called this function with both (s1, s2) and (s2, s1).</div>
<div class="line">        if (!unused_bits[i] &amp;&amp; !set_bits[i]) {</div>
<div class="line">            require_src2_be_dest = true;</div>
<div class="line">            s.add(z3::forall(s1, s2, deposit_field(s1, s2).extract(i, i) == s2.extract(i, i)));</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line">    if (require_src2_be_dest &amp;&amp; !src2.empty() &amp;&amp; dest != src2.front().src.container) {</div>
<div class="line">        std::stringstream ss;</div>
<div class="line">        ss &lt;&lt; &quot;destination &quot; &lt;&lt; dest &lt;&lt; &quot; will be corrupted because src2 &quot;</div>
<div class="line">           &lt;&lt; src2.front().src.container &lt;&lt; &quot; is not equal to dest&quot;;</div>
<div class="line">        return Error(ErrorCode::deposit_src2_must_be_dest, ss.str());</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    LOG3(&quot;Z3 expr:\n&quot; &lt;&lt; s);</div>
<div class="line">    switch (s.check()) {</div>
<div class="line">        case z3::unsat: {</div>
<div class="line">            return Error(ErrorCode::unsat, &quot;unsat&quot;);</div>
<div class="line">        }</div>
<div class="line">        case z3::sat: {</div>
<div class="line">            z3::model m = s.get_model();</div>
<div class="line">            LOG3(&quot;deposit-field mask.l = &quot; &lt;&lt; m.eval(l).get_numeral_int());</div>
<div class="line">            LOG3(&quot;deposit-field mask.h = &quot; &lt;&lt; m.eval(h).get_numeral_int());</div>
<div class="line">            LOG3(&quot;deposit-field rot = &quot; &lt;&lt; right_shift_val);</div>
<div class="line">            return boost::none;</div>
<div class="line">        }</div>
<div class="line">        case z3::unknown: {</div>
<div class="line">            return Error(ErrorCode::smt_sovler_unknown, &quot;smt solver cannot solve this in time&quot;);</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line">    return boost::none;</div>
<div class="line">}</div>
</div><!-- fragment --> </div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- HTML footer for doxygen 1.12.0-->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.12.0 </li>
  </ul>
</div>
</body>
</html>
