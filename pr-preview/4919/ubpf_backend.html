<!-- HTML header for doxygen 1.12.0-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.12.0"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>P4 Compiler Documentation (P4C): uBPF Backend</title>
<link rel="icon" href="p4-fav.svg" type="image/x-icon" />
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<!--  Add link to paragraphs   -->
<script type="text/javascript" src="doxygen-awesome-paragraph-link.js"></script>
<script type="text/javascript">
  DoxygenAwesomeParagraphLink.init()
</script>
<!-- Add copy button to code fragments  -->
<script type="text/javascript" src="doxygen-awesome-fragment-copy-button.js"></script>
<script type="text/javascript">
  DoxygenAwesomeFragmentCopyButton.init()
</script>
<!-- Add dark mode toggle -->
<script type="text/javascript" src="doxygen-awesome-darkmode-toggle.js"></script>
<script type="text/javascript">
  DoxygenAwesomeDarkModeToggle.init()
</script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="cookie.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="doxygen-awesome.css" rel="stylesheet" type="text/css"/>
<link href="doxygen-awesome-sidebar-only.css" rel="stylesheet" type="text/css"/>
<link href="doxygen-awesome-sidebar-only-darkmode-toggle.css" rel="stylesheet" type="text/css"/>
<link href="cards.css" rel="stylesheet" type="text/css"/>
<link href="flow.css" rel="stylesheet" type="text/css"/>
<link href="p4c_custom.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectlogo"><img alt="Logo" src="p4-logo.png"/></td>
  <td id="projectalign">
   <div id="projectname">P4C
   </div>
   <div id="projectbrief">The P4 Compiler</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.12.0 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() { codefold.init(0); });
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search',true);
  $(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function(){initNavTree('ubpf_backend.html',''); initResizable(true); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">uBPF Backend</div></div>
</div><!--header-->
<div class="contents">
<div class="toc"><h3>Table of Contents</h3>
<ul>
  <li class="level1 empty">
    <ul>
      <li class="level2">
        <a href="#background-1">Background</a>
        <ul>
          <li class="level3">
            <a href="#p4-1">P4</a>
          </li>
          <li class="level3">
            <a href="#ubpf">uBPF</a>
          </li>
        </ul>
      </li>
      <li class="level2">
        <a href="#compiling-p4-to-ubpf">Compiling P4 to uBPF</a>
        <ul>
          <li class="level3">
            <a href="#translation-between-p4-and-c">Translation between P4 and C</a>
          </li>
          <li class="level3">
            <a href="#how-to-use">How to use?</a>
          </li>
        </ul>
      </li>
    </ul>
  </li>
  <li class="level1">
    <a href="#ubpf-backend-test-programs">uBPF Backend test programs</a>
  </li>
  <li class="level1">
    <a href="#examples">Examples</a>
    <ul>
      <li class="level2">
        <a href="#packet-modification">Packet modification</a>
        <ul>
          <li class="level3">
            <a href="#ipv4--mpls-simple-actionsp4">IPv4 + MPLS (simple-actions.p4)</a>
          </li>
          <li class="level3">
            <a href="#ipv6-ipv6-actionsp4">IPv6 (ipv6-actions.p4)</a>
          </li>
        </ul>
      </li>
      <li class="level2">
        <a href="#registers">Registers</a>
        <ul>
          <li class="level3">
            <a href="#rate-limiter-rate-limiterp4">Rate limiter (rate-limiter.p4)</a>
          </li>
          <li class="level3">
            <a href="#rate-limiter-rate-limiter-structsp4">Rate limiter (rate-limiter-structs.p4)</a>
          </li>
          <li class="level3">
            <a href="#packet-counter-packet-counterp4">Packet counter (packet-counter.p4)</a>
          </li>
          <li class="level3">
            <a href="#simple-firewall-simple-firewallp4">Simple firewall (simple-firewall.p4)</a>
          </li>
        </ul>
      </li>
      <li class="level2">
        <a href="#tunneling">Tunneling</a>
        <ul>
          <li class="level3">
            <a href="#vxlan">VXLAN</a>
          </li>
          <li class="level3">
            <a href="#gprs-tunneling-protocol-gtp">GPRS Tunneling Protocol (GTP)</a>
          </li>
        </ul>
      </li>
    </ul>
  </li>
  <li class="level1">
    <a href="#ubpf-backend-testing">uBPF Backend testing</a>
    <ul>
      <li class="level2">
        <a href="#steps-to-run-tests">Steps to Run Tests:</a>
        <ul>
          <li class="level3 empty">
            <ul>
              <li class="level4">
                <a href="#custom-c-extern-functions">Custom C extern functions</a>
              </li>
            </ul>
          </li>
          <li class="level3">
            <a href="#known-limitations">Known limitations</a>
          </li>
          <li class="level3">
            <a href="#contact-1">Contact</a>
          </li>
        </ul>
      </li>
    </ul>
  </li>
</ul>
</div>
<div class="textblock"><p>The <b>p4c-ubpf</b> compiler allows to translate P4 programs into the uBPF programs. We use the uBPF implementation provided by <a href="https://github.com/Orange-OpenSource/p4rt-ovs">the P4rt-OVS switch</a>. The uBPF VM is based on the open-source implementation provided by <a href="https://github.com/iovisor/ubpf">IOVisor</a>.</p>
<p>The P4-to-uBPF compiler accepts only the P4_16 programs written for the <a href="../ubpf/p4include/ubpf_model.p4">ubpf_model.p4</a> architecture model.</p>
<p>The backend for uBPF is mostly based on P4-to-eBPF compiler. In fact, it implements the same concepts, but generates C code, which is compatible with the user space BPF implementation.</p>
<h2><a class="anchor" id="background-1"></a>
Background</h2>
<h3><a class="anchor" id="p4-1"></a>
P4</h3>
<p>Please, refer to <a class="el" href="ebpf_backend.html#p4">the overview of P4 written in eBPF Backend</a>.</p>
<h3><a class="anchor" id="ubpf"></a>
uBPF</h3>
<p><b>Why uBPF?</b> The uBPF Virtual Machine can be used in any solution implementing the kernel bypass (e.g. DPDK apps).</p>
<p>The uBPF project re-implements the <a class="el" href="ebpf_backend.html#ebpf">eBPF</a> kernel-based Virtual Machine. While the BPF programs are intented to run in the kernel, the uBPF project enables running the BPF programs in user-space applications. It contains eBPF assembler, disassembler, interpreter, and JIT compiler for x86-64.</p>
<p>Moreover, contrary to the eBPF implementation, uBPF is not licensed under GPL. The uBPF implementation is licensed under Apache License, version 2.0.</p>
<h2><a class="anchor" id="compiling-p4-to-ubpf"></a>
Compiling P4 to uBPF</h2>
<p>The scope of the uBPF backend is wider than the scope of the eBPF backend. Except for simple packet filtering the P4-to-uBPF compiler supports also P4 registers and programmable actions including packet's modifications and tunneling. For further details refer to <a href="p4include/ubpf_model.p4">uBPF architecture model</a>.</p>
<p><b>Note!</b> Due to the reason that the <code>standard_metadata</code> has been introduced to the uBPF model at 15th of May 2020 the old P4 programs will not work anymore. You should update your P4 program to the latest architecture model. Alternatively, you can also specify the old version of uBPF model: <code>#define UBPF_MODEL_VERSION 20200304</code> before <code>#include &lt;ubpf_model.p4&gt;</code>.</p>
<p>The current version of the P4-to-uBPF compiler translates P4_16 programs to programs written in the C language. This program is compatible with the uBPF VM and the <code>clang</code> compiler can be used to generate uBPF bytecode.</p>
<h3><a class="anchor" id="translation-between-p4-and-c"></a>
Translation between P4 and C</h3>
<p>We follow the convention of the P4-to-eBPF compiler so the parser translation is presented in the table <a class="el" href="ebpf_backend.html#translating-parsers">Translating parsers</a> from P4-to-eBPF. The translation of match-action pipelines is presented in the <a class="el" href="ebpf_backend.html#translating-match-action-pipelines">Translating match-action pipelines</a> table from P4-to-eBPF.</p>
<p>However, we introduced some modifications, which are listed below:</p>
<ul>
<li>The generated code uses user-level data types (e.g. uint8_t, etc.).</li>
<li>Methods to extract packet fields (e.g. load_dword, etc.) have been re-implemented to use user-space data types.</li>
<li>The uBPF helpers are imported into the C programs.</li>
<li>We have added <code>mark_to_drop()</code> extern to the <code>ubpf</code> model, so that packets to drop are marked in the P4-native way.</li>
<li>We have added support for P4 registers implemented as BPF maps</li>
</ul>
<h3><a class="anchor" id="how-to-use"></a>
How to use?</h3>
<p>The sample P4 programs are located in the <a href="./examples"><code>examples/</code> directory</a>. We have tested them with the <a href="https://github.com/Orange-OpenSource/p4rt-ovs">P4rt-OVS</a> switch - the Open vSwitch that can be extended with BPF programs at runtime. See the detailed tutorial on how to run and test those examples.</p>
<p>In order to generate the C code use the following command:</p>
<p><code>p4c-ubpf PROGRAM.p4 -o out.c</code></p>
<p>This command will generate out.c and the corresponding out.h file containing definitions of the packet structures and BPF maps.</p>
<p>Once the C program is generated it can be compiled using:</p>
<p><code>clang -O2 -target bpf -c out.c -o /tmp/out.o</code></p>
<p>The output file (<code>out.o</code>) can be injected to the uBPF VM.</p>
<h1><a class="anchor" id="ubpf-backend-test-programs"></a>
uBPF Backend test programs</h1>
<p>This Section contains description of the basic P4 programs, which were used to test the functionality of the P4-to-uBPF compiler. All tests have been run on the <a href="https://github.com/Orange-OpenSource/p4rt-ovs">P4rt-OVS</a> switch.</p>
<p>You can use <a href="https://github.com/p4lang/p4c/blob/main/backends/ubpf/tests/environment/Vagrantfile">Vagrantfile</a> to set up a test environment.</p>
<p>Before any experiment the following commands need to be invoked:</p>
<p><code>bash @section compile-p4-program-to-c-code compile P4 program to C code $ p4c-ubpf -o test.c PROGRAM.p4 $ sudo ovs-ofctl del-flows br0 @section compile-testc-to-bpf-machine-code compile test.c to BPF machine code $ clang-6.0 -O2 -I .. -target bpf -c test.c -o /tmp/test.o @section load-filter-bpf-program Load filter BPF program $ sudo ovs-ofctl load-bpf-prog br0 1 /tmp/test.o @section setup-rules-to-forward-traffic-bidirectional Setup rules to forward traffic (bidirectional) $ sudo ovs-ofctl add-flow br0 in_port=2,actions=prog:1,output:1 $ sudo ovs-ofctl add-flow br0 in_port=1,actions=prog:1,output:2 </code></p>
<p><b>Note!</b> The P4-uBPF compiler works properly with <code>clang-6.0</code>. We noticed some problems when using older versions of clang (e.g. 3.9).</p>
<h1><a class="anchor" id="examples"></a>
Examples</h1>
<p>This section presents how to run and test the P4-uBPF compiler.</p>
<h2><a class="anchor" id="packet-modification"></a>
Packet modification</h2>
<p>This section presents a P4 program, which modifies the packet's fields.</p>
<h3><a class="anchor" id="ipv4--mpls-simple-actionsp4"></a>
IPv4 + MPLS (simple-actions.p4)</h3>
<p><b>Key:</b> Source IPv4 address</p>
<p><b>Actions:</b></p>
<ul>
<li>mpls_decrement_ttl</li>
<li>mpls_set_label</li>
<li>mpls_set_label_decrement_ttl</li>
<li>mpls_modify_tc</li>
<li>mpls_set_label_tc</li>
<li>mpls_modify_stack</li>
<li>change_ip_ver</li>
<li>ip_swap_addrs</li>
<li>ip_modify_saddr</li>
<li>Reject</li>
</ul>
<p>Sample usage:</p>
<p><code>bash @section template-ovs-ofctl-update-bpf-map-bridge-program-id-map-id-key-key-data-value-value-data Template: ovs-ofctl update-bpf-map &lt;BRIDGE&gt; &lt;PROGRAM-ID&gt; &lt;MAP-ID&gt; key &lt;KEY-DATA&gt; value &lt;VALUE-DATA&gt; $ sudo ovs-ofctl update-bpf-map br0 1 0 key 14 0 16 172 value 0 0 0 0 0 0 0 0 0 0 0 0 # decrements MPLS TTL $ sudo ovs-ofctl update-bpf-map br0 1 0 key 14 0 16 172 value 1 0 0 0 24 0 0 0 0 0 0 0 # sets MPLS label to 24 $ sudo ovs-ofctl update-bpf-map br0 1 0 key 14 0 16 172 value 2 0 0 0 24 0 0 0 0 0 0 0 # sets MPLS label to 24 and decrements TTL $ sudo ovs-ofctl update-bpf-map br0 1 0 key 14 0 16 172 value 3 0 0 0 3 0 0 0 0 0 0 0 # modifies MPLS TC (set value to 3) $ sudo ovs-ofctl update-bpf-map br0 1 0 key 14 0 16 172 value 4 0 0 0 24 0 0 0 1 0 0 0 # sets MPLS label to 24 and TC to 1 $ sudo ovs-ofctl update-bpf-map br0 1 0 key 14 0 16 172 value 5 0 0 0 1 0 0 0 0 0 0 0 # modifies stack value of MPLS header $ sudo ovs-ofctl update-bpf-map br0 1 0 key 14 0 16 172 value 6 0 0 0 6 0 0 0 0 0 0 0 # changes IP version to 6. $ sudo ovs-ofctl update-bpf-map br0 1 0 key 14 0 16 172 value 7 0 0 0 0 0 0 0 0 0 0 0 # swaps IP addresses $ sudo ovs-ofctl update-bpf-map br0 1 0 key 14 0 16 172 value 8 0 0 0 1 0 16 172 0 0 0 0 # sets source IP address to 172.16.0.1 </code></p>
<h3><a class="anchor" id="ipv6-ipv6-actionsp4"></a>
IPv6 (ipv6-actions.p4)</h3>
<p>The aim of this example is to test modification of wider packet's fields. Thus, we have used the IPv6 headers.</p>
<p>The match key is source IPv6 address. The P4 program implements three actions:</p>
<ul>
<li>ipv6_modify_dstAddr - modifies IPv6 destination address;</li>
<li>ipv6_swap_addr - swaps IPv6 addresses.</li>
<li>set_flowlabel - tests modification of custom-length field, where <code>length % 8 != 0</code>.</li>
</ul>
<p>Sample usage: <code>bash @section changes-destination-ipv6-address-from-fe80a0027fffe7eb95-to-e00-simple-random-value Changes destination IPv6 address from fe80::a00:27ff:fe7e:b95 to e00::: (simple, random value) $ sudo ovs-ofctl update-bpf-map br0 1 0 key 254 128 0 0 0 0 0 0 10 0 39 255 254 21 180 17 value 0 0 0 0 14 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 @section swaps-source-and-destination-ipv6-addresses Swaps source and destination IPv6 addresses $ sudo ovs-ofctl update-bpf-map br0 1 0 key 254 128 0 0 0 0 0 0 10 0 39 255 254 21 180 17 value 1 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 @section sets-flow-label-to-1 Sets Flow Label to 1. $ sudo ovs-ofctl update-bpf-map br0 1 0 key 254 128 0 0 0 0 0 0 10 0 39 255 254 21 180 17 value 2 0 0 0 1 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 </code></p>
<h2><a class="anchor" id="registers"></a>
Registers</h2>
<p>This section presents P4 programs, which use registers. Register can be declared this way:</p>
<p><code>Register&lt;value_type, key_type&gt;(number_of_elements) register_t;</code> <br  />
</p>
<p>The parameters are as follows:</p>
<ul>
<li><code>value_type</code> - is bit array type (i.e. bit&lt;32&gt;) or struct like type <br  />
</li>
<li><code>key_type</code> - is bit array type (i.e. bit&lt;32&gt;) or struct like type <br  />
</li>
<li><code>number_of_elements</code> - the maximum number of key-value pairs</li>
</ul>
<p>Currently, the <code>ubpf</code> architecture model does not allow to initialize registers with default values. Initialization has to be done by a control plane.</p>
<h3><a class="anchor" id="rate-limiter-rate-limiterp4"></a>
Rate limiter (rate-limiter.p4)</h3>
<p>The rate limiter uses two registers. First which counts the number of packets and second which holds timestamps.</p>
<p>This rate limiter limits the number of packets per second. Responsible for that are two variables BUCKET_SIZE and WINDOW_SIZE placed in rate-limiter.p4 file. For instance now BUCKET_SIZE has value of 10 and WINDOW_SIZE has value of 100. It means that 10 packets are passed in 100 ms window. It also means 100 packets per second. If you send 1470 Bytes width packets the bit rate should not exceed 1.176 Mbit/s (1470B * 8 * (10/100ms)).</p>
<p>Due to registers limitation before starting your own tests initialize rate limiter registers with zeros:</p>
<p><code>bash @section initalizes-timestamp_r-register Initalizes timestamp_r register $ sudo ovs-ofctl update-bpf-map br0 1 0 key 0 0 0 0 value 0 0 0 0 @section initalizes-count_r-register Initalizes count_r register $ sudo ovs-ofctl update-bpf-map br0 1 1 key 0 0 0 0 value 0 0 0 0 </code></p>
<p>To measure the bandwidth use the <code>iperf</code> tool: <br  />
</p>
<p>Start a <code>iperf</code> UDP server</p>
<p><code>bash $ iperf -s -u </code></p>
<p>Then, run <code>iperf</code> client:</p>
<p><code>bash $ iperf -c &lt;server_ip&gt; -b 10M -l 1470 </code></p>
<h3><a class="anchor" id="rate-limiter-rate-limiter-structsp4"></a>
Rate limiter (rate-limiter-structs.p4)</h3>
<p>The same rate limiter as above, but implemented using structs. <br  />
</p>
<h3><a class="anchor" id="packet-counter-packet-counterp4"></a>
Packet counter (packet-counter.p4)</h3>
<p>The packet counter counts every packet passed via the program. Before tests initialize packet counter register with zeros: <br  />
</p>
<p><code>bash @section initalizes-packet_counter_reg-register Initalizes packet_counter_reg register $ sudo ovs-ofctl update-bpf-map br0 1 0 key 0 0 0 0 value 0 0 0 0 </code></p>
<p>Then generate any network traffic. To check if the program counts packets use i.e. <br  />
</p>
<p><code>bash $ watch sudo ovs-ofctl dump-bpf-map br0 1 0 </code></p>
<h3><a class="anchor" id="simple-firewall-simple-firewallp4"></a>
Simple firewall (simple-firewall.p4)</h3>
<p>This is very simple example of stateful firewall. Every TCP packet is analyzed to track the state of the TCP connection. If the traffic belongs to known connection it is passed. Otherwise, it is dropped. <br  />
 Notice that the example program uses hash function which is constrained to hash only 64 bit values - that's why TCP connection is identified via IP source and destination address. This is the known limitation of the <code>uBPF</code> backend used in P4rt-OVS (to be fixed in the future).</p>
<p>Due to registers limitation before starting your own tests initialize simple firewall registers with zeros:</p>
<p><code>bash @section initalizes-conn_state-register-key-is-a-output-from-a-hash-function-for-client192168110-and-server-19216811 Initalizes conn_state register (key is a output from a hash function for client(192.168.1.10) and server (192.168.1.1)) $ sudo ovs-ofctl update-bpf-map br0 1 0 key 172 192 20 5 value 0 0 0 0 @section initalizes-conn_srv_addr-register-key-is-a-output-from-a-hash-function-for-client192168110-and-server-19216811 Initalizes conn_srv_addr register (key is a output from a hash function for client(192.168.1.10) and server (192.168.1.1)) $ sudo ovs-ofctl update-bpf-map br0 1 1 key 172 192 20 5 value 0 0 0 0 </code> <br  />
</p>
<p>To test simple firewall you can use as an example <code>ptf/simple-firewall-test.py</code> test.</p>
<h2><a class="anchor" id="tunneling"></a>
Tunneling</h2>
<p>This section presents more complex examples of packet tunneling operations. There are two P4 programs used:</p>
<ul>
<li><code>tunneling.p4</code>, which implements MPLS tunneling,</li>
<li><code>vxlan.p4</code>, which implements more complex packet tunneling: VXLAN.</li>
</ul>
<h3><a class="anchor" id="vxlan"></a>
VXLAN</h3>
<p>To run example compile <code>vxlan.p4</code> with <code>p4c</code> and then <code>clang-6.0</code>.</p>
<p>Sample usage:</p>
<p><code>bash @section sets-action-vxlan_decap-value-0-for-packets-matching-rule-vni25-key-25 Sets action vxlan_decap() (value 0) for packets matching rule VNI=25 (key 25) @section handled-by-the-table-upstream_tbl-map-id-0-and-bpf-prog-1 handled by the table upstream_tbl (map id 0) and BPF prog 1. sudo ovs-ofctl update-bpf-map br0 1 0 key 25 0 0 0 value 0 0 0 0 @section sets-action-vxlan_encap-value-0-for-packets-matching-rule-ip-dstaddr17216014-key-14-0-16-172 Sets action vxlan_encap() (value 0) for packets matching rule IP dstAddr=172.16.0.14 (key 14 0 16 172) @section handled-by-the-table-downstream_tbl-map-id-1-and-bpf-prog-1 handled by the table downstream_tbl (map id 1) and BPF prog 1. sudo ovs-ofctl update-bpf-map br0 1 1 key 14 0 16 172 value 0 0 0 0 </code></p>
<h3><a class="anchor" id="gprs-tunneling-protocol-gtp"></a>
GPRS Tunneling Protocol (GTP)</h3>
<p>To run example compile <code>gtp.p4</code> with <code>p4c</code> and then <code>clang-6.0</code>.</p>
<p>To test encapsulation:</p>
<p><code>bash @section for-downstream_tbl-id-1-sets-action-gtp_encap-value-0-and-gtp-teid3-for-packets-with-destination-ip-address-17216014 For downstream_tbl (ID 1) sets action gtp_encap() (value 0) and GTP TEID=3 for packets with destination IP address 172.16.0.14. $ sudo ovs-ofctl update-bpf-map br0 1 1 key 14 0 16 172 value 0 0 0 0 3 0 0 0 </code></p>
<p>To test decapsulation:</p>
<p><code>bash @section for-upstream_tbl-id-0-sets-action-gtp_decap-for-packets-matching-gtp-teid3 For upstream_tbl (ID 0) sets action gtp_decap() for packets matching GTP TEID=3. $ sudo ovs-ofctl update-bpf-map br0 1 0 key 3 0 0 0 value 0 0 0 0 </code></p>
<p>Scapy can be used to easily test GTP protocol:</p>
<p><code>python &gt;&gt;&gt; load_contrib('gtp') &gt;&gt;&gt; p = Ether(dst='08:00:27:7e:0b:95', src='08:00:27:15:b4:11')/IP(dst='172.16.0.14', src='172.16.0.12')/UDP(sport=2152,dport=2152)/GTPHeader(teid=3)/IP(dst='172.16.0.14', src='172.16.0.12')/ICMP() &gt;&gt;&gt; sendp(p, iface='eth1') </code>  </p>
<h1><a class="anchor" id="ubpf-backend-testing"></a>
uBPF Backend testing</h1>
<p>Tests use two VMs:</p><ul>
<li><code>switch</code> - on this VM we run PTF tests</li>
<li><code>generator</code> - expose two interfaces to P4rt-OVS switch installed on switch VM</li>
</ul>
<p><b>Note.</b> As P4rt-OVS (the test uBPF target) is built on top of DPDK the tests require to be run in virtual environment with two VMs (<code>generator</code> + <code>switch</code>).</p>
<h2><a class="anchor" id="steps-to-run-tests"></a>
Steps to Run Tests:</h2>
<ol type="1">
<li>Install <code>Virtualbox</code> and <code>Vagrant</code> on you machine: <pre class="fragment">`sudo apt install -y virtualbox vagrant`
</pre></li>
</ol>
<ol type="1">
<li><p class="startli">Install and configure environment for tests</p>
<p class="startli"><code>bash $ cd environment $ vagrant up </code></p>
</li>
<li><p class="startli">Run PTF agent on generator machine</p>
<p class="startli"><code>bash $ vagrant ssh generator $ cd ptf/ptf_nn/ $ sudo python ptf_nn_agent.py --device-socket 0@tcp://192.168.100.20:10001 -i 0-1@enp0s8 -i 0-2@enp0s9 -v </code></p>
</li>
<li><p class="startli">Compile P4 programs on switch machine</p>
<p class="startli"><code>bash $ vagrant ssh switch $ cd p4c/backends/ubpf/tests $ sudo python compile_testdata.py </code></p>
</li>
<li><p class="startli">Run tests on switch machine</p>
<p class="startli"><code>bash $ vagrant ssh switch $ cd p4c/backends/ubpf/tests $ sudo ptf --failfast --test-dir ptf/ --device-socket 0-{1-2}@tcp://192.168.100.20:10001 --platform nn </code></p>
<p class="startli"><b>Important</b> <br  />
</p>
<p class="startli">After any system's reboot the below scripts have to be run again:</p>
<p class="startli"><code>bash $ cd /vagrant $ ./configure_dpdk.sh #This script configures dpdk interfaces that p4rt-ovs switch use $ ./run_switch.sh # This script runs p4rt-switch </code></p>
<p class="startli">In case of tests errors please check if the <code>p4rt-ovs</code> switch is up and running (ie. <code>ps aux</code>).</p>
</li>
</ol>
<p>--&gt;</p>
<h4><a class="anchor" id="custom-c-extern-functions"></a>
Custom C extern functions</h4>
<p>The P4 to uBPF compiler allows to define custom C extern functions and call them from P4 program as P4 action.</p>
<p>The design of this feature is identical to <code>p4c-ebpf</code>. See <a class="el" href="ebpf_backend.html#how-to-inject-custom-extern-function-to-the-generated-ebpf-program">the P4 to eBPF documentation</a> to learn how to use this feature. Note that the C extern function written for <code>p4c-ubpf</code> must be compatible with userspace BPF VM.</p>
<h3><a class="anchor" id="known-limitations"></a>
Known limitations</h3>
<ul>
<li>No support for some P4 constructs (meters, counters, etc.)</li>
</ul>
<h3><a class="anchor" id="contact-1"></a>
Contact</h3>
<p>Tomasz Osi≈Ñski &lt;<a href="#" onclick="location.href='mai'+'lto:'+'tom'+'as'+'z.o'+'si'+'nsk'+'i2'+'@or'+'an'+'ge.'+'co'+'m'; return false;">tomas<span class="obfuscator">.nosp@m.</span>z.os<span class="obfuscator">.nosp@m.</span>inski<span class="obfuscator">.nosp@m.</span>2@or<span class="obfuscator">.nosp@m.</span>ange.<span class="obfuscator">.nosp@m.</span>com</a>&gt;</p>
<p>Mateusz Kossakowski &lt;<a href="#" onclick="location.href='mai'+'lto:'+'mat'+'eu'+'sz.'+'ko'+'ssa'+'ko'+'wsk'+'i@'+'ora'+'ng'+'e.c'+'om'; return false;">mateu<span class="obfuscator">.nosp@m.</span>sz.k<span class="obfuscator">.nosp@m.</span>ossak<span class="obfuscator">.nosp@m.</span>owsk<span class="obfuscator">.nosp@m.</span>i@ora<span class="obfuscator">.nosp@m.</span>nge.<span class="obfuscator">.nosp@m.</span>com</a>&gt; </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- HTML footer for doxygen 1.12.0-->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.12.0 </li>
  </ul>
</div>
</body>
</html>
