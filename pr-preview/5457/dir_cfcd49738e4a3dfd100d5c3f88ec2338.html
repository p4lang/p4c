<!-- HTML header for doxygen 1.13.2-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.13.2"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>P4 Compiler Documentation (P4C): bf-p4c Directory Reference</title>
<link rel="icon" href="p4-fav.svg" type="image/x-icon" />
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<!--  Add link to paragraphs   -->
<script type="text/javascript" src="doxygen-awesome-paragraph-link.js"></script>
<script type="text/javascript">
  DoxygenAwesomeParagraphLink.init()
</script>
<!-- Add copy button to code fragments  -->
<script type="text/javascript" src="doxygen-awesome-fragment-copy-button.js"></script>
<script type="text/javascript">
  DoxygenAwesomeFragmentCopyButton.init()
</script>
<!-- Add dark mode toggle -->
<script type="text/javascript" src="doxygen-awesome-darkmode-toggle.js"></script>
<script type="text/javascript">
  DoxygenAwesomeDarkModeToggle.init()
</script>
<!-- Add interactive TOC -->
<script type="text/javascript" src="doxygen-awesome-interactive-toc.js"></script>
<script type="text/javascript">
  DoxygenAwesomeInteractiveToc.init()
</script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="cookie.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="doxygen-awesome.css" rel="stylesheet" type="text/css"/>
<link href="doxygen-awesome-sidebar-only.css" rel="stylesheet" type="text/css"/>
<link href="doxygen-awesome-sidebar-only-darkmode-toggle.css" rel="stylesheet" type="text/css"/>
<link href="doxygen-awesome-interactive-toc.js" rel="stylesheet" type="text/css"/>
<link href="cards.css" rel="stylesheet" type="text/css"/>
<link href="flow.css" rel="stylesheet" type="text/css"/>
<link href="p4c_custom.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectlogo"><img alt="Logo" src="p4-logo.png"/></td>
  <td id="projectalign">
   <div id="projectname">P4C
   </div>
   <div id="projectbrief">The P4 Compiler</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.13.2 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() { codefold.init(0); });
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search',true);
  $(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function(){initNavTree('dir_cfcd49738e4a3dfd100d5c3f88ec2338.html',''); initResizable(true); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div class="header">
  <div class="headertitle"><div class="title">bf-p4c Directory Reference</div></div>
</div><!--header-->
<div class="contents">
<div class="dynheader">
Directory dependency graph for bf-p4c:</div>
<div class="dyncontent">
<div class="center"><div class="zoom"><iframe scrolling="no" frameborder="0" src="dir_cfcd49738e4a3dfd100d5c3f88ec2338_dep.svg" width="100%" height="394"><p><b>This browser is not able to show SVG: try Firefox, Chrome, Safari, or Opera instead.</b></p></iframe></div></div>
</div>
<table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a id="subdirs" name="subdirs"></a>
Directories</h2></td></tr>
<tr class="memitem:"><td class="memItemLeft" align="right" valign="top"><span class="iconfclosed"></span>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="dir_2500fc76dc86f1d109233f07bd0b825d.html">arch</a></td></tr>
<tr class="separator:"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:"><td class="memItemLeft" align="right" valign="top"><span class="iconfclosed"></span>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="dir_54636a323854fa4ed58265cc9fed6918.html">common</a></td></tr>
<tr class="separator:"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:"><td class="memItemLeft" align="right" valign="top"><span class="iconfclosed"></span>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="dir_cd1a054759a91c281709df13c3f68bbf.html">control-plane</a></td></tr>
<tr class="separator:"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:"><td class="memItemLeft" align="right" valign="top"><span class="iconfclosed"></span>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="dir_489b2fa9997e1ea7fa7cdc3889915e01.html">ir</a></td></tr>
<tr class="separator:"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:"><td class="memItemLeft" align="right" valign="top"><span class="iconfclosed"></span>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="dir_608bfeb6f320bc454c1a336df1a7b0c5.html">lib</a></td></tr>
<tr class="separator:"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:"><td class="memItemLeft" align="right" valign="top"><span class="iconfclosed"></span>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="dir_e178cf2a346ade3a1eb2db096d3fcd51.html">logging</a></td></tr>
<tr class="separator:"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:"><td class="memItemLeft" align="right" valign="top"><span class="iconfclosed"></span>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="dir_857f3c92975693a500d20eb2ae0a0f68.html">mau</a></td></tr>
<tr class="separator:"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:"><td class="memItemLeft" align="right" valign="top"><span class="iconfclosed"></span>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="dir_fa05020fcc169594fb37adffb5d12b5c.html">midend</a></td></tr>
<tr class="separator:"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:"><td class="memItemLeft" align="right" valign="top"><span class="iconfclosed"></span>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="dir_fde6314643abbd9680fd62b071b23ff1.html">parde</a></td></tr>
<tr class="separator:"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:"><td class="memItemLeft" align="right" valign="top"><span class="iconfclosed"></span>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="dir_44803a37bb937697b251a472bd5d1435.html">phv</a></td></tr>
<tr class="separator:"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a id="files" name="files"></a>
Files</h2></td></tr>
<tr class="memitem:"><td class="memItemLeft" align="right" valign="top"><a href="asm_8h_source.html"><span class="icondoc"></span></a>&#160;</td><td class="memItemRight" valign="bottom"><b>asm.h</b></td></tr>
<tr class="separator:"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:"><td class="memItemLeft" align="right" valign="top"><a href="tofino_2bf-p4c_2backend_8h_source.html"><span class="icondoc"></span></a>&#160;</td><td class="memItemRight" valign="bottom"><b>backend.h</b></td></tr>
<tr class="separator:"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:"><td class="memItemLeft" align="right" valign="top"><a href="bf-p4c-options_8h_source.html"><span class="icondoc"></span></a>&#160;</td><td class="memItemRight" valign="bottom"><b>bf-p4c-options.h</b></td></tr>
<tr class="separator:"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:"><td class="memItemLeft" align="right" valign="top"><a href="device_8h_source.html"><span class="icondoc"></span></a>&#160;</td><td class="memItemRight" valign="bottom"><b>device.h</b></td></tr>
<tr class="separator:"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:"><td class="memItemLeft" align="right" valign="top"><a href="backends_2tofino_2bf-p4c_2frontend_8h_source.html"><span class="icondoc"></span></a>&#160;</td><td class="memItemRight" valign="bottom"><b>frontend.h</b></td></tr>
<tr class="separator:"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:"><td class="memItemLeft" align="right" valign="top"><a href="tofino_2bf-p4c_2midend_8h_source.html"><span class="icondoc"></span></a>&#160;</td><td class="memItemRight" valign="bottom"><b>midend.h</b></td></tr>
<tr class="separator:"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:"><td class="memItemLeft" align="right" valign="top"><a href="tofino_2bf-p4c_2version_8h_source.html"><span class="icondoc"></span></a>&#160;</td><td class="memItemRight" valign="bottom"><b>version.h</b></td></tr>
<tr class="separator:"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table>
<a name="details" id="details"></a><h2 class="groupheader">Detailed Description</h2>
<h1><a class="anchor" id="setup-1"></a>
Setup</h1>
<p>This repo contains the tofino backend for p4c v1.2 compiler. It contains <em>just</em> the backend and can only be built within the p4c build infrastructure in <a href="#" onclick="location.href='mai'+'lto:'+'git'+'@g'+'ith'+'ub'+'.co'+'m'; return false;">git@g<span class="obfuscator">.nosp@m.</span>ithu<span class="obfuscator">.nosp@m.</span>b.com</a>:p4lang/p4c. To use this repo: </p><pre class="fragment">git clone git@github.com:barefootnetworks/p4c-extension-tofino.git
cd p4c-extension-tofino
./bootstrap.sh
</pre><p>This will check out the p4lang/p4c repository, move the p4c-extension-tofino to <code>p4c/extensions/bfn</code>, install the necessary dependences, and build the project.</p>
<h1><a class="anchor" id="dependencies-7"></a>
Dependencies</h1>
<ul>
<li>Tofino assembler and Harlyn model for testing the output of the Tofino backend. The test scripts will look for sibling repos (in preference to installed versions), so the easiest is to check out these repos in parent of the <code>p4c</code> folder and build them there:</li>
</ul>
<div class="fragment"><div class="line">git clone git@github.com:barefootnetworks/tofino-asm.git</div>
<div class="line">git clone git@github.com:barefootnetworks/model.git</div>
<div class="line">cd tofino-asm</div>
<div class="line">make all</div>
<div class="line">cd ..</div>
<div class="line">cd model</div>
<div class="line">./autogen.sh</div>
<div class="line">./configure</div>
<div class="line">make</div>
</div><!-- fragment --><ul>
<li>It may be desirable to checkout the "cdodd-simple_harness" branch of the model to get the latest code for the test harness we're using.</li>
<li>The Harlyn model requires additional dependences; please refer to its own documentation: <a href="https://barefootnetworks.atlassian.net/wiki/pages/viewpage.action?pageId=17006668">https://barefootnetworks.atlassian.net/wiki/pages/viewpage.action?pageId=17006668</a>. Only the dependences required by the "model" are needed (i.e., we don't use the driver in the compiler tests).</li>
<li>The tests depend on GNU utilities. On macOS, these can be installed with <code>brew install coreutils</code>.</li>
</ul>
<h1><a class="anchor" id="tofino-mid-end-and-back-end-design"></a>
Tofino mid-end and back-end design</h1>
<p>The mid-end and back-end of the compiler are where all the Tofino-specific work is done. To some extenet the boundary between mid-end and back-end is arbitrary, but the most logical place to put it is at the point where we transform the IR from frontend P4-oriented form (generally, a global scope containing a bunch of named symbols of various types) to Tofino-oriented form (a Pipe object containing ingress and egress parsers, deparsers, and tables).</p>
<h2><a class="anchor" id="mid-end-1"></a>
Mid-end</h2>
<p>There are a variety of transformations we may want to do on the IR when it is still in P4 oriented form. These could be considered non-tofino-specific transforms, since they operate at the frontend IR level, but are generally directed by target-specific considerations. Some could also be implemented to operate on the backend IR form.</p>
<ul>
<li>Sequential action analysis. Tofino actions happen in parallel, so to ensure proper sequential behavior, we need to analyze actions and substitute intermediate temporaries (essentially, copt propagation) to ensure that each of the primitives within an action can be executed in parallel.</li>
<li>Field packing and unpacking. Tofino can only deal with 8, 16, and 32 bit quantities, so fields larger than 32 bits must be split. The parser operates on bytes, so fields in headers that need to be parsed/deparsed that aren't on byte boundaries need to be reorganized so as to be byte aligned. This may necessitate introducing additional metadata.</li>
<li>POV allocation. Tofino requires POV bits stored as additional metadata for the deparser to control deparsing. These bit should also be used for validity checking of headers in tables.</li>
<li>Bridged metadata. We need to introduce a bridged metadata fake header that is deparsed from the ingress and parser in egress to carry metadat information between ingress and egress.</li>
</ul>
<h2><a class="anchor" id="back-end"></a>
Back-end</h2>
<p>The backend is where most of the resource allocation decisions take place. Resource allocation passes should take extra ‘hints’ inputs to drive decisions based on previous failed attempts that triggered backtracking. This is a potential exponential blowup, so care needs to be taken to avoid attempts that are probably unprofitable &ndash; tuning will be needed.</p>
<p>To the extent that it does not complicate the code too much, it should be parameterized based on architecture details. The intent is that the code should be reusable for multiple architecture families.</p>
<p>The code here is organized into <code>parde</code> (parser-deparser), <code>mau</code> (match-action table), and <code>phv</code> (phv allocation and management) directories. To some extent these are independent, but there are interdependecies.</p>
<h3><a class="anchor" id="ir"></a>
IR</h3>
<p>There are a variety of Tofino-specific IR classes used to hold information needed to track tofino resource use and manage the allocation of those resources.</p>
<h5><code>IR::BFN::Pipe</code></h5>
<p>An abstraction of a single Tofino pipeline, this object is basically just a container for other (Parser, Deparser, and MAU) specific objects. This becomes the root object of the IR tree after the mid-end.</p>
<p>Because most visitors only care about part of the Pipe object (eg, just the MAU, or just the Parser), we define special visitor bases <code>MauInspector</code>, <code>MauModifier</code>, <code>MauTransform</code>, <code>PardeInspector</code>, <code>PardeModifier</code>, and <code>PardeTransform</code> that visit just those parts of the tree of interest to Mau or Parde. Other parts of the tree are skipped.</p>
<h5><code>IR::BFN::Unit</code></h5>
<p>Abstract base class for parts of the pipe that access the PHV &ndash; tables, parser states, and the deparser. The <code>stage()</code> function returns an integer associated with the order of the unit's execution &ndash; the actual stage for tables, -1 for parser states (they come before stage 0), and a large number for the deparser (after all stages).</p>
<h5><code>IR::BFN::Parser</code></h5>
<h5><code>IR::BFN::Deparser</code></h5>
<h5><code>IR::MAU::Table</code></h5>
<p>The mau code is largely organized around the <code>IR::MAU::Table</code> ir class, which represents a Tofino-specific logical table. Such a table has an (optional) gateway, with an expression, condition, and (optional) payload action, an (optional) match table, and zero or more attached tables (indirect, action data, selector, meter, counter, ...). There is a next table map that contains references to sequences of other tables to run based on the gateway result or action run.</p>
<ul>
<li><code>gateway_expr</code> boolean expression that the gateway tests, or <code>nullptr</code> if there is no gateway</li>
<li><code>gateway_payload</code> action to run if the match-action table does not run</li>
<li><code>gateway_cond</code> if <code>eval(gateway_expr) == gateway_cond</code> then the <code>match_table</code> should run. If there is no <code>gateway_expr</code> or no <code>match_table</code>, this is ignored.</li>
<li><code>match_table</code> match table to run iff <code>gateway_expr == nullptr</code> or <code>eval(gateway_expr) == gateway_cond</code></li>
<li><code>actions</code> list of action functions that might be in the table. <b>TBD:</b> probably need to differentiate default-only vs non-default-only vs other actions somehow?</li>
<li><code>attached</code> list of attached support tables &ndash; ternary indirection, action data, selection, meter, counter, stateful alu...</li>
<li><code>next</code> map from gateway conditions and actions to control dependent table sequences. Keys are cstrings that may be action names or keywords.<ul>
<li><code>true</code> &ndash; next to run iff <code>eval(gateway_expr) == true</code>. Not allowed if there is a <code>match_table</code> and <code>gateway_cond == true</code>, since then the match table result applies.</li>
<li><code>false</code> &ndash; next to run iff <code>eval(gateway_expr) == false</code>. Not allowed if there is a <code>match_table</code> and <code>gateway_cond == false</code>, since then the match table result applies.</li>
<li><em>action</em> &ndash; next to run if the <code>match_table</code> runs this action.</li>
<li><code>$miss</code> &ndash; next to run if the <code>match_table</code> runs and misses. This will override if the action also specifies a next.</li>
<li><code>default</code> &ndash; next to run if the <code>match_table</code> runs and nothing else applies.</li>
</ul>
</li>
</ul>
<p><code>IR::MAU::Table</code> objects are initially created by the mid-end corresponding to each gateway and match table in the P4 program. These tables will then be manipulated (split, combined, and reordered) by various passes to get them into a form where they can be fit into the Tofino pipeline, then allocated to specific stages/logical ids/resources within the pipeline.</p>
<h5><code>IR::MAU::TableSeq</code></h5>
<p>A sequence of logical tables to run in order. Each table will run, followed by any control dependent tables, followed by the next table in the sequence. By definition, tables in a <code>TableSeq</code> are control-independent, but may be data-dependent. The <code>TableSeq</code> also contains a bit-matrix that tracks data dependencies between tables in the sequence including their control-depedent tables. Tables that are not data dependent may be reordered.</p>
<h3><a class="anchor" id="passes"></a>
Passes</h3>
<p>The first step in the Tofino backend is converting the P4-level IR into the needed forms for the backend. In most cases, this will be a fairly simple wrapper around some P4-level IR objects, organizing them into the rough form that tofino requires.</p>
<h4><a class="anchor" id="parde"></a>
parde</h4>
<p>Parser and deparser processing starts with extracting the state machine graph from the P4-level IR. Since the IR (currently) does not support loops, but the state machine may involve loops, this will require using a representation that breaks the loops. We could extend the IR to allow loops (would require extending the Visitor base classes to deal with loops rather than just detecting them and throwing an error), but that may not be necessary. A series of transformation passes can then optimize the parser:</p>
<ul>
<li>Loop unrolling &ndash; states that have backreferences (loops) can be unrolled by cloning the backreferenced tree, limited by the maximum header stack size involved</li>
<li>Parser state splitting &ndash; states that do too much (write too many output bytes) need to be split into multiple states. States could also be split into minimal states that each do a single thing that will later bre recombined.</li>
<li>Parser state combining &ndash; small consecutive states can be combined.</li>
</ul>
<p>It may be that simply splitting states into the smallest possible fragments and then recombining them works well for general optimization. Alternately, other things could be tried. The important thing is flexibility in the representation, to permit experimentation.</p>
<p>Deparser handling in v1.1 is a matter of extracting the deparser from the parser state machine and blackboxes that do deparser-relevant processing (checksum units, learning filters, ...). Its not clear whether this is best done from the P4-level parser IR, or from some later state of the parser IR (after some backend transformations).</p>
<h4><a class="anchor" id="mau-1"></a>
mau</h4>
<p>Mau processing begins by converting the P4 IR into a pair of <code>IR::MAU::TableSeq</code> objects (one for ingress, and one for egress &ndash; this is the 'mid-end'), which is prototyped in <code>extract_maupipe.cpp</code>. Then the code can reorganized by various optimization passes that will be needed:</p>
<ul>
<li>Gateway analysis and splitting &ndash; gateway tables that are too complex for tofino must be split int multiple gateways.</li>
<li>Gateway merging &ndash; simple consecutive gateways can be combined into a single gateway</li>
<li>Gateway duplication &ndash; gateways that have multiple tables dependent on their result can be duplicated, with each duplicated gateway having fewer dependent tables. This allows more flexibility for table scehduling and may only be done if table placement fails and backtracks. A prototype implemention exists in <code>split_gateways.cpp</code>.</li>
<li>Table analysis &ndash; figure out what resources a logical table will need (at least number of memories, ixbar space, other units) for table placement to refer to. Decide on width, exact match groups, ways, putting immediate data into overhead vs action data table etc. Another place that we may backtrack to if table placement fails. A partial prototype exists in <code>table_layout.cpp</code></li>
<li>Table insertion &ndash; if later passes decide they need to insert new tables, we need a 'pass' to backtrack to and do that. First time through this pass will do nothing, then other passes may trigger a 'new table needed' backtrack that backtracks to this pass to insert the table.</li>
<li>Table reorg &ndash; any optimizations that involve splitting or combining tables may occur here. For example, actions that are too complex for tofino could be implemented by splitting off part of the action into a followon table.</li>
<li>Table dependency analysis &ndash; find match, action, and write(reverse) dependencies between tables</li>
</ul>
<p>Once the these initial passes are complete, we can do the main table placement analysis. This pass will map logical tables to specific stages and logical ids. Gateways with no match table may be combined with match tables with no gateway as part of this process. Table sequences may be reordered if dependencies allow to better fit. Tables that do not fit within a stage will be split into multiple tables. A prototype implementation exists in <code>table_placement.cpp</code>, but not properly support backtracking.</p>
<p>After table placement, tables will be allocated to specific resources in their stage (some of this may be concurrent with placement, to the extent that it affects placement). Unused resources (memories) may be added to tables to allow them to expand to larger than minimum required size.</p>
<p>Flow analysis of metadata and header field use in tables then determines which metadata fields are independent, as well as identifying all the phv use constraints on fields based on how they are use in tables.</p>
<p>Once final PHV allocation has been done, tables may need to be modified to work with the allocation.</p>
<ul>
<li>transform action statements that operate on fields that have been split by phv allocation into mulitple statements.</li>
<li>allocate action data to the action bus based on which PHV registers need access to it.</li>
</ul>
<p>a single pass over the final IR should suffice for generating asm code.</p>
<h4><a class="anchor" id="phv-1"></a>
phv</h4>
<p>PHV allocation and management interacts heavily with the other parts of the compiler. The basic design is to have an initial PHV pass that gathers basic information on all header and metadata fields in the program, then passes in mau and parde can augment this information with additional constraints as the run.</p>
<p>Once most of the allocation decisions for other passes have been made, PHV allocation will assign physical PHV slots for each field, possibly splitting fields. When this fails, PHV allocation needs to provide information about why it is failing (running out of a particular size, or group, or ?) that can be used by passes we backtrack to to modify their uses.</p>
<p>We can build an interference graph for all fields, allowing use to experiment with graph coloring algorithms for PHV allocation, as well as simpler greedy allocation.</p>
<p>Inspector passes to find constraints could logically be either part of the component they are anaylzing (parde or mau) or part of phv allocation.</p>
<h1><a class="anchor" id="driver"></a>
Driver</h1>
<p>Driver is a program that interacts with the user and drives the whole compilation process.</p>
<p>Driver consists of two Python 3 scripts <code>driver.py</code> and <code>barefoot.py</code> (see <code>barefoot.BarefootBackend</code> class). From inside the compiler, the <code>bf-p4c-options</code> handles the arguments and their additional parsing.</p>
<p><b>Developer environment variables</b>:</p><ul>
<li><code>P4C_BUILD_TYPE</code> - if set to <code>DEVELOPER</code> then the driver will parse developer arguments.</li>
<li><code>P4C_BIN_DIR</code> - Directory containing P4C binaries (p4c-barefoor, bfas...).</li>
<li><code>P4C_CFG_PATH</code> - Schemas directory.</li>
</ul>
<p>Other environment variables and all command line options are documented in the <a href="https://wiki.ith.intel.com/display/BXDCOMPILER/Getting+started">user guide wiki</a></p>
<h2><a class="anchor" id="driverpy"></a>
driver.py</h2>
<p>This script is part of the public frontend and serves as the base driver. It is being invoked by <code>barefoot.py</code> with setup argument parser and commands. This script sets up the output program structure (output folder) and executes all setup processes.</p>
<h2><a class="anchor" id="barefootpy"></a>
barefoot.py</h2>
<p>Driver for bf-p4c. It sets up all the command line options and commands for specific compilation processes (such as preprocessor invocation...).</p>
<h2><a class="anchor" id="driver-testing"></a>
Driver testing</h2>
<p>There are scripts to test driver's correctness - <code>test_p4c_driver.py</code>, which runs the tests and <code>p4c_driver_tests.py</code>, which contains the tests.</p>
<p>To add new tests for driver, one has to edit the <code>test_matrix</code> dictionary in <code>p4c_driver_tests.py</code>. Each entry in this dictionary is a test. To add a new test a new key has to be created and its value has to be a tuple with following parameters (in order listed):</p><ol type="1">
<li>List of compiler arguments.</li>
<li>String with expected xfail message or None if fail is not expected.</li>
<li>List of files that the driver should have or have not created after the test being run. The file has to be specified by a relative path and if the path includes <code>!</code> as the first character, then this checks that the file does not exist. E. g. if <code>/pipe/foo</code> was used, then tests will check that file <code>foo</code> exists in a folder <code>pipe</code> after compilation of the test. Using <code>!/pipe/foo</code> would check that the file DOES NOT exist.</li>
<li>Reference source json (<code>source.json</code>) file or None.</li>
<li>Reference configuration file or None.</li>
<li>Expected string in STDOUT or None.</li>
</ol>
<h1><a class="anchor" id="compilers-output"></a>
Compiler's output</h1>
<p>General documentation for the compiler output can be found on the wiki:</p><ul>
<li><a href="https://wiki.ith.intel.com/pages/viewpage.action?pageId=1981604254#Gettingstarted-SynopsisofCompilerInputsandOutputs">Synopsis of Compiler Inputs and Outputs</a></li>
<li><a href="https://wiki.ith.intel.com/pages/viewpage.action?pageId=1981604254#Gettingstarted-TheManifestFile:InformationontheGeneratedFiles">The Manifest File: Information on the Generated Files</a></li>
<li><a href="https://wiki.ith.intel.com/display/BXDCOMPILER/Appendix+F_+Compiler+Output+for+Debugging">Compiler output for debugging</a></li>
</ul>
<p>Produced JSON files have certain schemas, which have to adhere to <a href="https://github.com/intel-restricted/networking.switching.barefoot.compiler-interfaces/blob/master/README.md#schema-versioning-policy">schema policies</a>. When changing schemas, these changes have to be approved by the <em>schema review board</em> this is because these schemas are often used by mutliple projects (p4c, p4i, drivers...) and since this is always produced by p4c, the p4c approval is always needed. More about the review process can be found <a href="https://github.com/intel-restricted/networking.switching.barefoot.compiler-interfaces/blob/master/README.md#contributions-and-change-process">here</a>.</p>
<table class="markdownTable">
<tr class="markdownTableHead">
<th class="markdownTableHeadNone"><b>File</b>   </th><th class="markdownTableHeadNone"><b>Schema</b>   </th><th class="markdownTableHeadNone"><b>Consumers</b>   </th><th class="markdownTableHeadNone"><b>Schema</b>    </th></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">context.json   </td><td class="markdownTableBodyNone">Context_schema   </td><td class="markdownTableBodyNone">Drivers, Model, P4I   </td><td class="markdownTableBodyNone"><a href="https://github.com/intel-restricted/networking.switching.barefoot.compiler-interfaces/blob/master/schemas/context_schema.py">context_schema.py</a>    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">bfrt.json   </td><td class="markdownTableBodyNone">Bfrt_schema   </td><td class="markdownTableBodyNone">Drivers   </td><td class="markdownTableBodyNone"><a href="https://github.com/intel-restricted/networking.switching.barefoot.compiler-interfaces/blob/master/schemas/bfrt_schema.py">bfrt_schema.py</a>    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">manifest.json   </td><td class="markdownTableBodyNone">Manifest_schema   </td><td class="markdownTableBodyNone">Drivers, P4I   </td><td class="markdownTableBodyNone"><a href="https://github.com/intel-restricted/networking.switching.barefoot.compiler-interfaces/blob/master/schemas/manifest_schema.py">manifest_schema.py</a>    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">resources.json   </td><td class="markdownTableBodyNone">Resources_schema   </td><td class="markdownTableBodyNone">P4I   </td><td class="markdownTableBodyNone"><a href="https://github.com/intel-restricted/networking.switching.barefoot.compiler-interfaces/blob/master/schemas/resources_schema.py">resources_schema.py</a>    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">mau.json   </td><td class="markdownTableBodyNone">Mau_schema   </td><td class="markdownTableBodyNone">P4I   </td><td class="markdownTableBodyNone"><a href="https://github.com/intel-restricted/networking.switching.barefoot.compiler-interfaces/blob/master/schemas/mau_schema.py">mau_schema.py</a>    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">phv.json   </td><td class="markdownTableBodyNone">Phv_schema   </td><td class="markdownTableBodyNone">P4I   </td><td class="markdownTableBodyNone"><a href="https://github.com/intel-restricted/networking.switching.barefoot.compiler-interfaces/blob/master/schemas/phv_schema.py">phv_schema.py</a>    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">dep.json   </td><td class="markdownTableBodyNone">Table_Graph_schema   </td><td class="markdownTableBodyNone">P4I   </td><td class="markdownTableBodyNone"><a href="https://github.com/intel-restricted/networking.switching.barefoot.compiler-interfaces/blob/master/schemas/table_graph_schema.py">table_graph_schema.py</a>    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">power.json   </td><td class="markdownTableBodyNone">Power_schema   </td><td class="markdownTableBodyNone">P4I   </td><td class="markdownTableBodyNone"><a href="https://github.com/intel-restricted/networking.switching.barefoot.compiler-interfaces/blob/master/schemas/power_schema.py">power_schema.py</a>    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">source.json   </td><td class="markdownTableBodyNone">Source_info_schema   </td><td class="markdownTableBodyNone">P4I   </td><td class="markdownTableBodyNone"><a href="https://github.com/intel-restricted/networking.switching.barefoot.compiler-interfaces/blob/master/schemas/source_info_schema.py">source_info_schema.py</a>    </td></tr>
<tr class="markdownTableRowEven">
<td class="markdownTableBodyNone">metrics.json   </td><td class="markdownTableBodyNone">Metrics_schema   </td><td class="markdownTableBodyNone">P4C   </td><td class="markdownTableBodyNone"><a href="https://github.com/intel-restricted/networking.switching.barefoot.compiler-interfaces/blob/master/schemas/metrics_schema.py">metrics_schema.py</a>    </td></tr>
<tr class="markdownTableRowOdd">
<td class="markdownTableBodyNone">events.json   </td><td class="markdownTableBodyNone">Event_log_schema   </td><td class="markdownTableBodyNone">P4I   </td><td class="markdownTableBodyNone"><a href="https://github.com/intel-restricted/networking.switching.barefoot.compiler-interfaces/blob/master/schemas/event_log_schema.py">event_log_schema.py</a>   </td></tr>
</table>
<p>Assembler source code (<code>*.bfa</code>) is a structured file using YAML syntax described in <code>SYNTAX.yaml</code> and is extensible for multiple architectures (Tofino, Tofino2...). </p>
</div><!-- contents -->
</div><!-- doc-content -->
<!-- HTML footer for doxygen 1.13.2-->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="dir_dec21994cd756836ecefab773235960a.html">backends</a></li><li class="navelem"><a class="el" href="dir_c4ded715df726299fc9cd18b15628924.html">tofino</a></li><li class="navelem"><a class="el" href="dir_cfcd49738e4a3dfd100d5c3f88ec2338.html">bf-p4c</a></li>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.13.2 </li>
  </ul>
</div>
</body>
</html>
