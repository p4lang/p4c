<!-- HTML header for doxygen 1.11.0-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.11.0"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>P4C: uBPF Backend test programs</title>
<link rel="icon" href="p4-fav.svg" type="image/svg+xml"  />
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<!--  Add link to paragraphs   -->
<script type="text/javascript" src="doxygen-awesome-paragraph-link.js"></script>
<script type="text/javascript">
  DoxygenAwesomeParagraphLink.init()
</script>
<!-- Add copy button to code fragments  -->
<script type="text/javascript" src="doxygen-awesome-fragment-copy-button.js"></script>
<script type="text/javascript">
  DoxygenAwesomeFragmentCopyButton.init()
</script>
<!-- Add dark mode toggle -->
<script type="text/javascript" src="doxygen-awesome-darkmode-toggle.js"></script>
<script type="text/javascript">
  DoxygenAwesomeDarkModeToggle.init()
</script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="cookie.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="doxygen-awesome.css" rel="stylesheet" type="text/css"/>
<link href="doxygen-awesome-sidebar-only.css" rel="stylesheet" type="text/css"/>
<link href="doxygen-awesome-sidebar-only-darkmode-toggle.css" rel="stylesheet" type="text/css"/>
<link href="cards.css" rel="stylesheet" type="text/css"/>
<link href="flow.css" rel="stylesheet" type="text/css"/>
<link href="p4c_custom.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectlogo"><img alt="Logo" src="p4-logo.png"/></td>
  <td id="projectalign">
   <div id="projectname">P4C
   </div>
   <div id="projectbrief">The P4 Compiler</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.11.0 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() { codefold.init(0); });
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search',true);
  $(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function(){initNavTree('md__2home_2runner_2work_2p4c_2p4c_2backends_2ubpf_2docs_2_e_x_a_m_p_l_e_s.html',''); initResizable(true); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">uBPF Backend test programs</div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a class="anchor" id="autotoc_md293"></a> This file contains description of the basic <a class="el" href="namespace_p4.html">P4</a> programs, which were used to test the functionality of the P4-to-uBPF compiler. All tests have been run on the <a href="https://github.com/Orange-OpenSource/p4rt-ovs">P4rt-OVS</a> switch. You can use <a href="../tests/environment/Vagrantfile">Vagrantfile</a> to set up a test environment.</p>
<p>Before any experiment the following commands need to be invoked:</p>
<div class="fragment"><div class="line"># compile P4 program to C code</div>
<div class="line">$ p4c-ubpf -o test.c PROGRAM.p4 </div>
<div class="line">$ sudo ovs-ofctl del-flows br0</div>
<div class="line"># compile test.c to BPF machine code</div>
<div class="line">$ clang-6.0 -O2 -I .. -target bpf -c test.c -o /tmp/test.o</div>
<div class="line"># Load filter BPF program</div>
<div class="line">$ sudo ovs-ofctl load-bpf-prog br0 1 /tmp/test.o</div>
<div class="line"># Setup rules to forward traffic (bidirectional)</div>
<div class="line">$ sudo ovs-ofctl add-flow br0 in_port=2,actions=prog:1,output:1</div>
<div class="line">$ sudo ovs-ofctl add-flow br0 in_port=1,actions=prog:1,output:2</div>
</div><!-- fragment --><p><b>Note!</b> The P4-uBPF compiler works properly with <code>clang-6.0</code>. We noticed some problems when using older versions of clang (e.g. 3.9).</p>
<h1><a class="anchor" id="autotoc_md294"></a>
Examples</h1>
<p>This section presents how to run and test the P4-uBPF compiler.</p>
<h2><a class="anchor" id="autotoc_md295"></a>
Packet modification</h2>
<p>This section presents a <a class="el" href="namespace_p4.html">P4</a> program, which modifies the packet's fields.</p>
<h3><a class="anchor" id="autotoc_md296"></a>
IPv4 + MPLS (simple-actions.p4)</h3>
<p><b>Key:</b> Source IPv4 address</p>
<p><b>Actions:</b></p>
<ul>
<li>mpls_decrement_ttl</li>
<li>mpls_set_label</li>
<li>mpls_set_label_decrement_ttl</li>
<li>mpls_modify_tc</li>
<li>mpls_set_label_tc</li>
<li>mpls_modify_stack</li>
<li>change_ip_ver</li>
<li>ip_swap_addrs</li>
<li>ip_modify_saddr</li>
<li>Reject</li>
</ul>
<p>Sample usage:</p>
<div class="fragment"><div class="line"># Template: ovs-ofctl update-bpf-map &lt;BRIDGE&gt; &lt;PROGRAM-ID&gt; &lt;MAP-ID&gt; key &lt;KEY-DATA&gt; value &lt;VALUE-DATA&gt;</div>
<div class="line">$ sudo ovs-ofctl update-bpf-map br0 1 0 key 14 0 16 172 value 0 0 0 0 0 0 0 0 0 0 0 0 # decrements MPLS TTL</div>
<div class="line">$ sudo ovs-ofctl update-bpf-map br0 1 0 key 14 0 16 172 value 1 0 0 0 24 0 0 0 0 0 0 0 # sets MPLS label to 24</div>
<div class="line">$ sudo ovs-ofctl update-bpf-map br0 1 0 key 14 0 16 172 value 2 0 0 0 24 0 0 0 0 0 0 0 # sets MPLS label to 24 and decrements TTL</div>
<div class="line">$ sudo ovs-ofctl update-bpf-map br0 1 0 key 14 0 16 172 value 3 0 0 0 3 0 0 0 0 0 0 0 # modifies MPLS TC (set value to 3)</div>
<div class="line">$ sudo ovs-ofctl update-bpf-map br0 1 0 key 14 0 16 172 value 4 0 0 0 24 0 0 0 1 0 0 0 # sets MPLS label to 24 and TC to 1</div>
<div class="line">$ sudo ovs-ofctl update-bpf-map br0 1 0 key 14 0 16 172 value 5 0 0 0 1 0 0 0 0 0 0 0 # modifies stack value of MPLS header</div>
<div class="line">$ sudo ovs-ofctl update-bpf-map br0 1 0 key 14 0 16 172 value 6 0 0 0 6 0 0 0 0 0 0 0 # changes IP version to 6.</div>
<div class="line">$ sudo ovs-ofctl update-bpf-map br0 1 0 key 14 0 16 172 value 7 0 0 0 0 0 0 0 0 0 0 0 # swaps IP addresses</div>
<div class="line">$ sudo ovs-ofctl update-bpf-map br0 1 0 key 14 0 16 172 value 8 0 0 0 1 0 16 172 0 0 0 0 # sets source IP address to 172.16.0.1</div>
</div><!-- fragment --><h3><a class="anchor" id="autotoc_md297"></a>
IPv6 (ipv6-actions.p4)</h3>
<p>The aim of this example is to test modification of wider packet's fields. Thus, we have used the IPv6 headers.</p>
<p>The match key is source IPv6 address. The <a class="el" href="namespace_p4.html">P4</a> program implements three actions:</p>
<ul>
<li>ipv6_modify_dstAddr - modifies IPv6 destination address;</li>
<li>ipv6_swap_addr - swaps IPv6 addresses.</li>
<li>set_flowlabel - tests modification of custom-length field, where <code>length % 8 != 0</code>.</li>
</ul>
<p>Sample usage: </p><div class="fragment"><div class="line"># Changes destination IPv6 address from fe80::a00:27ff:fe7e:b95 to e00::: (simple, random value)</div>
<div class="line">$ sudo ovs-ofctl update-bpf-map br0 1 0 key 254 128 0 0 0 0 0 0 10 0 39 255 254 21 180 17 value 0 0 0 0 14 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0</div>
<div class="line"># Swaps source and destination IPv6 addresses</div>
<div class="line">$ sudo ovs-ofctl update-bpf-map br0 1 0 key 254 128 0 0 0 0 0 0 10 0 39 255 254 21 180 17 value 1 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0</div>
<div class="line"># Sets Flow Label to 1.</div>
<div class="line">$ sudo ovs-ofctl update-bpf-map br0 1 0 key 254 128 0 0 0 0 0 0 10 0 39 255 254 21 180 17 value 2 0 0 0 1 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md298"></a>
Registers</h2>
<p>This section presents <a class="el" href="namespace_p4.html">P4</a> programs, which use registers. Register can be declared this way:</p>
<p><code>Register&lt;value_type, key_type&gt;(number_of_elements) register_t;</code> <br  />
</p>
<p>The parameters are as follows:</p>
<ul>
<li><code>value_type</code> - is bit array type (i.e. bit&lt;32&gt;) or struct like type <br  />
</li>
<li><code>key_type</code> - is bit array type (i.e. bit&lt;32&gt;) or struct like type <br  />
</li>
<li><code>number_of_elements</code> - the maximum number of key-value pairs</li>
</ul>
<p>Currently, the <code>ubpf</code> architecture model does not allow to initialize registers with default values. Initialization has to be done by a control plane.</p>
<h3><a class="anchor" id="autotoc_md299"></a>
Rate limiter (rate-limiter.p4)</h3>
<p>The rate limiter uses two registers. First which counts the number of packets and second which holds timestamps.</p>
<p>This rate limiter limits the number of packets per second. Responsible for that are two variables BUCKET_SIZE and WINDOW_SIZE placed in rate-limiter.p4 file. For instance now BUCKET_SIZE has value of 10 and WINDOW_SIZE has value of 100. It means that 10 packets are passed in 100 ms window. It also means 100 packets per second. If you send 1470 Bytes width packets the bit rate should not exceed 1.176 Mbit/s (1470B * 8 * (10/100ms)).</p>
<p>Due to registers limitation before starting your own tests initialize rate limiter registers with zeros:</p>
<div class="fragment"><div class="line"># Initalizes timestamp_r register</div>
<div class="line">$ sudo ovs-ofctl update-bpf-map br0 1 0 key 0 0 0 0 value 0 0 0 0</div>
<div class="line"># Initalizes count_r register</div>
<div class="line">$ sudo ovs-ofctl update-bpf-map br0 1 1 key 0 0 0 0 value 0 0 0 0</div>
</div><!-- fragment --><p>To measure the bandwidth use the <code>iperf</code> tool: <br  />
</p>
<p>Start a <code>iperf</code> UDP server</p>
<div class="fragment"><div class="line">$ iperf -s -u</div>
</div><!-- fragment --><p>Then, run <code>iperf</code> client:</p>
<div class="fragment"><div class="line">$ iperf -c &lt;server_ip&gt; -b 10M -l 1470</div>
</div><!-- fragment --><h3><a class="anchor" id="autotoc_md300"></a>
Rate limiter (rate-limiter-structs.p4)</h3>
<p>The same rate limiter as above, but implemented using structs. <br  />
</p>
<h3><a class="anchor" id="autotoc_md301"></a>
Packet counter (packet-counter.p4)</h3>
<p>The packet counter counts every packet passed via the program. Before tests initialize packet counter register with zeros: <br  />
</p>
<div class="fragment"><div class="line"># Initalizes packet_counter_reg register</div>
<div class="line">$ sudo ovs-ofctl update-bpf-map br0 1 0 key 0 0 0 0 value 0 0 0 0</div>
</div><!-- fragment --><p>Then generate any network traffic. To check if the program counts packets use i.e. <br  />
</p>
<div class="fragment"><div class="line">$ watch sudo ovs-ofctl dump-bpf-map br0 1 0</div>
</div><!-- fragment --><h3><a class="anchor" id="autotoc_md302"></a>
Simple firewall (simple-firewall.p4)</h3>
<p>This is very simple example of stateful firewall. Every TCP packet is analyzed to track the state of the TCP connection. If the traffic belongs to known connection it is passed. Otherwise, it is dropped. <br  />
 Notice that the example program uses hash function which is constrained to hash only 64 bit values - that's why TCP connection is identified via IP source and destination address. This is the known limitation of the <code>uBPF</code> backend used in P4rt-OVS (to be fixed in the future).</p>
<p>Due to registers limitation before starting your own tests initialize simple firewall registers with zeros:</p>
<div class="fragment"><div class="line"># Initalizes conn_state register (key is a output from a hash function for client(192.168.1.10) and server (192.168.1.1))</div>
<div class="line">$ sudo ovs-ofctl update-bpf-map br0 1 0 key 172 192 20 5 value 0 0 0 0</div>
<div class="line"># Initalizes conn_srv_addr register (key is a output from a hash function for client(192.168.1.10) and server (192.168.1.1))</div>
<div class="line">$ sudo ovs-ofctl update-bpf-map br0 1 1 key 172 192 20 5 value 0 0 0 0</div>
</div><!-- fragment --><p>To test simple firewall you can use as an example <code>ptf/simple-firewall-test.py</code> test.</p>
<h2><a class="anchor" id="autotoc_md303"></a>
Tunneling</h2>
<p>This section presents more complex examples of packet tunneling operations. There are two <a class="el" href="namespace_p4.html">P4</a> programs used:</p>
<ul>
<li><code>tunneling.p4</code>, which implements MPLS tunneling,</li>
<li><code>vxlan.p4</code>, which implements more complex packet tunneling: VXLAN.</li>
</ul>
<h3><a class="anchor" id="autotoc_md304"></a>
VXLAN</h3>
<p>To run example compile <code>vxlan.p4</code> with <code>p4c</code> and then <code>clang-6.0</code>.</p>
<p>Sample usage:</p>
<div class="fragment"><div class="line"># Sets action vxlan_decap() (value 0) for packets matching rule VNI=25 (key 25) </div>
<div class="line"># handled by the table upstream_tbl (map id 0) and BPF prog 1.</div>
<div class="line">sudo ovs-ofctl update-bpf-map br0 1 0 key 25 0 0 0 value 0 0 0 0</div>
<div class="line"># Sets action vxlan_encap() (value 0) for packets matching rule IP dstAddr=172.16.0.14 (key 14 0 16 172) </div>
<div class="line"># handled by the table downstream_tbl (map id 1) and BPF prog 1.</div>
<div class="line">sudo ovs-ofctl update-bpf-map br0 1 1 key 14 0 16 172 value 0 0 0 0</div>
</div><!-- fragment --><h3><a class="anchor" id="autotoc_md305"></a>
GPRS Tunneling Protocol (GTP)</h3>
<p>To run example compile <code>gtp.p4</code> with <code>p4c</code> and then <code>clang-6.0</code>.</p>
<p>To test encapsulation:</p>
<div class="fragment"><div class="line"># For downstream_tbl (ID 1) sets action gtp_encap() (value 0) and GTP TEID=3 for packets with destination IP address 172.16.0.14.</div>
<div class="line">$ sudo ovs-ofctl update-bpf-map br0 1 1 key 14 0 16 172 value 0 0 0 0 3 0 0 0</div>
</div><!-- fragment --><p>To test decapsulation:</p>
<div class="fragment"><div class="line"># For upstream_tbl (ID 0) sets action gtp_decap() for packets matching GTP TEID=3.</div>
<div class="line">$ sudo ovs-ofctl update-bpf-map br0 1 0 key 3 0 0 0 value 0 0 0 0</div>
</div><!-- fragment --><p>Scapy can be used to easily test GTP protocol:</p>
<div class="fragment"><div class="line">&gt;&gt;&gt; load_contrib(<span class="stringliteral">&#39;gtp&#39;</span>)</div>
<div class="line">&gt;&gt;&gt; p = Ether(dst=<span class="stringliteral">&#39;08:00:27:7e:0b:95&#39;</span>, src=<span class="stringliteral">&#39;08:00:27:15:b4:11&#39;</span>)/IP(dst=<span class="stringliteral">&#39;172.16.0.14&#39;</span>, src=<span class="stringliteral">&#39;172.16.0.12&#39;</span>)/UDP(sport=2152,dport=2152)/GTPHeader(teid=3)/IP(dst=<span class="stringliteral">&#39;172.16.0.14&#39;</span>, src=<span class="stringliteral">&#39;172.16.0.12&#39;</span>)/ICMP()</div>
<div class="line">&gt;&gt;&gt; sendp(p, iface=<span class="stringliteral">&#39;eth1&#39;</span>)</div>
</div><!-- fragment --> </div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- HTML footer for doxygen 1.11.0-->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.11.0 </li>
  </ul>
</div>
</body>
</html>
