name: Build Doxygen
on:
  push:
    branches: [main]
  pull_request:
    types: [opened, synchronize, reopened, labeled]

permissions:
  contents: read

jobs:
  build:
    # Only run on main or if the documentation label is present
    if: |
      github.event_name == 'push' || 
      contains(github.event.pull_request.labels.*.name, 'documentation')
    runs-on: ubuntu-latest
    env:
      DOXYGEN_VERSION: 1.13.2
      DOXYGEN_AWESOME_VERSION: 2.3.4

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y clang graphviz
          wget https://github.com/doxygen/doxygen/releases/download/Release_${DOXYGEN_VERSION//./_}/doxygen-${DOXYGEN_VERSION}.linux.bin.tar.gz
          tar xzvf doxygen-${DOXYGEN_VERSION}.linux.bin.tar.gz
          cd doxygen-${DOXYGEN_VERSION} && sudo make install

      - name: Build Docs
        run: |
          git clone --depth 1 -b v${{ env.DOXYGEN_AWESOME_VERSION }} https://github.com/jothepro/doxygen-awesome-css docs/doxygen/awesome_css
          cd docs/doxygen
          doxygen doxygen.cfg
          touch build/html/.nojekyll

      # workflow_run payloads don't reliably include pull_request.number.
      # Write the PR number into the artifact so the deploy workflow can read it back.
      - name: Write PR number metadata
        if: github.event_name == 'pull_request'
        run: |
          mkdir -p docs/doxygen/build/html/_meta
          echo "${{ github.event.pull_request.number }}" > docs/doxygen/build/html/_meta/pr_number.txt

      - name: Upload Build Artifact
        uses: actions/upload-artifact@v6
        with:
          name: doxygen-html
          path: docs/doxygen/build/html/
          retention-days: 1
