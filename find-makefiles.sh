#!/bin/sh

# Copyright 2013-present Barefoot Networks, Inc. 
# 
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
# 
#    http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

# This script creates the file `otherMakefiles.am` for the P4C compiler toolchain.
# The file is created by inserting "include" statements for other Makefile.am files.
# The included Makefile.am files are sought in two places:
# - all Makefile.am files found in the subdirectories of the "backends" directory.
#   These files are part of the "standard" back-ends distributed with the compiler.
# - all Makefile.am files found in subdirectories of the "extensions" directory.
#   These makefiles are part of customized extensions fo the compiler.
#   (The files in the "extensions" directory are not part of the compiler source tree;
#   they are expected to be symlinks to custom back-ends.)

resultMakefile="otherMakefiles.am"
dirsToSearch="backends extensions"

echo "Creating $resultMakefile"

echo "### This file is automatically generated" >$resultMakefile
echo "### by the program find-makefiles.sh" >>$resultMakefile

for d in $dirsToSearch; do
    for f in $d/*; do 
        if [ -f $f/Makefile-p4c-extension.am ]; then
            echo "Adding $f/Makefile-p4c-extension.am"
            echo "include \$(srcdir)/$f/Makefile-p4c-extension.am" >>$resultMakefile
        elif [ -f $f/Makefile.am ]; then
            echo "Adding $f/Makefile.am"
            echo "include \$(srcdir)/$f/Makefile.am" >>$resultMakefile
        fi
    done
done
